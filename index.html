<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-16LMNCXZQ1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-16LMNCXZQ1');
    </script>

    <!-- Microsoft Clarity -->
    <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "v7i4u6c1ct");
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JISHENG OS // ULTIMATE PERSISTENT</title>
    
    <!-- 核心驱动：BrowserFS 文件系统 -->
    <script src="https://unpkg.com/browserfs@1.4.3/dist/browserfs.min.js"></script>
    <!-- JSZip 解压缩库 -->
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <!-- V86 虚拟机模拟器 -->
    <script src="https://cdn.jsdelivr.net/npm/v86@latest/build/libv86.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #0a0a0f;
            --glass-surface: rgba(24, 24, 32, 0.88);
            --glass-surface-light: rgba(36, 36, 48, 0.92);
            --glass-highlight: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-blue: #0078d4;
            --accent-cyan: #00d4ff;
            --text-main: #ffffff;
            --text-muted: #8a8a9a;
            --taskbar-height: 48px;
            --win-close-red: #e81123;
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body, html {
            width: 100%; height: 100%;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, 'Segoe UI', sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }



        /* === SVG 图标基础样式 === */
        .icon-svg {
            width: 24px; height: 24px;
            stroke: currentColor;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .icon-svg.sm { width: 16px; height: 16px; }
        .icon-svg.lg { width: 32px; height: 32px; }
        .icon-svg.xl { width: 40px; height: 40px; }

        /* === 背景系统 === */
        #dynamic-bg {
            position: absolute; inset: 0;
            background-size: cover;
            background-position: center;
            transition: background-image 0.6s ease;
            z-index: 0;
        }
        
        .ambient-overlay {
            position: absolute; inset: 0;
            background: 
                radial-gradient(ellipse at 30% 20%, rgba(0, 120, 212, 0.08) 0%, transparent 50%),
                linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.7) 100%);
            z-index: 1; pointer-events: none;
        }

        /* === 噪点 === */
        .noise-layer {
            position: fixed; inset: 0; z-index: 9990;
            opacity: 0.025; pointer-events: none; mix-blend-mode: overlay;
        }

        /* === 玻璃容器 === */
        .ultra-glass {
            background: var(--glass-surface);
            backdrop-filter: blur(40px) saturate(120%);
            -webkit-backdrop-filter: blur(40px) saturate(120%);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.6);
        }

        /* === 桌面 === */
        .desktop { position: absolute; inset: 0; bottom: var(--taskbar-height); z-index: 5; }
        
        .desktop-icons { 
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0; 
            display: block; 
            pointer-events: auto; 
        } 

        .desktop-icon { 
            position: absolute; 
            width: 82px; 
            height: 90px; 
            padding: 10px 4px; 
            display: flex; flex-direction: column; align-items: center; gap: 6px; 
            border-radius: 6px; cursor: pointer; 
            border: 1px solid transparent; 
            transition: background 0.15s, border 0.15s; 
            z-index: 1; 
        } 
        
        .desktop-icon:hover { 
            background: rgba(255,255,255,0.08); 
        } 
        
        .desktop-icon.selected { 
            background: rgba(0, 120, 212, 0.25); 
            border-color: rgba(0, 120, 212, 0.5); 
            backdrop-filter: blur(4px); 
        } 

        .desktop-icon:active { transform: scale(0.98); } 
        
        .desktop-icon.dragging { 
            opacity: 0.6; 
            z-index: 1000; 
            pointer-events: none; 
        } 
        
        .desktop-icon .icon-svg { 
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.4)); 
            color: rgba(255,255,255,0.9); 
            width: 36px; height: 36px; 
        } 
        
        .desktop-icon .label { 
            font-size: 11px; 
            font-weight: 500; 
            text-align: center; 
            text-shadow: 0 1px 4px rgba(0,0,0,0.9); 
            line-height: 1.3; 
            color: #fff; 
            word-break: break-all; 
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; 
            padding: 0 2px; 
            border-radius: 2px; 
        } 
        .desktop-icon.selected .label { color: #fff; } 

        .selection-box { 
            position: fixed; 
            background: rgba(0, 120, 212, 0.2); 
            border: 1px solid rgba(0, 120, 212, 0.6); 
            z-index: 999; 
            pointer-events: none; 
            display: none; 
        } 

        .desktop-grid-overlay { 
            position: absolute; inset: 0; pointer-events: none; z-index: 0; 
        } 

        .drag-preview { 
            position: fixed; pointer-events: none; z-index: 10000; opacity: 0.8; 
            background: rgba(24, 24, 32, 0.8); border-radius: 8px; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; 
        }

        /* === 窗口系统 === */
        .window {
            position: absolute; min-width: 400px; min-height: 300px;
            display: flex; flex-direction: column; z-index: 10;
            transition: opacity 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 
                0 0 0 1px rgba(255,255,255,0.05),
                0 25px 60px rgba(0,0,0,0.5);
        }
        .window.focused { 
            z-index: 100; 
            box-shadow: 
                0 0 0 1px rgba(0, 120, 212, 0.3),
                0 30px 70px rgba(0,0,0,0.6);
        }
        .window.minimized { transform: scale(0.9) translateY(30px); opacity: 0; pointer-events: none; }
        .window.maximized { 
            top: 0 !important; left: 0 !important; 
            width: 100% !important; height: calc(100% - var(--taskbar-height)) !important; 
            border-radius: 0 !important; 
        }

        /* 标题栏 */
        .title-bar {
            height: 36px; min-height: 36px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.15);
            border-bottom: 1px solid var(--glass-border);
            /* === 新增这行，修复移动端拖拽卡顿 === */
            touch-action: none; 
        }
        .title-bar-left {
            display: flex; align-items: center; gap: 10px; 
            padding-left: 14px; flex: 1; height: 100%;
        }
        .window-icon .icon-svg { width: 16px; height: 16px; color: var(--text-muted); }
        .window-title-text { font-size: 12px; font-weight: 500; color: var(--text-muted); }

        /* 窗口控制按钮 */
        .window-controls { display: flex; height: 100%; }
        .win-btn {
            width: 46px; height: 100%;
            display: flex; align-items: center; justify-content: center;
            cursor: default; color: var(--text-muted);
            transition: all 0.1s;
        }
        .win-btn .icon-svg { width: 10px; height: 10px; stroke-width: 2; }
        .win-btn:hover { background: rgba(255,255,255,0.08); color: var(--text-main); }
        .win-btn.close:hover { background: var(--win-close-red); color: white; }

        /* === 窗口吸附预览 === */
        #snap-preview {
            position: fixed;
            background: rgba(0, 120, 212, 0.25);
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
            transition: all 0.15s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0;
            pointer-events: none;
            z-index: 9998;
            backdrop-filter: blur(10px);
        }

        /* === 浏览器 === */
        .browser-nav {
            display: flex; align-items: center; gap: 6px; padding: 8px 12px;
            background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border);
        }
        .nav-btn {
            width: 32px; height: 32px; border-radius: 6px; border: none;
            background: transparent; color: var(--text-muted);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.15s;
        }
        .nav-btn .icon-svg { width: 16px; height: 16px; }
        .nav-btn:hover:not(:disabled) { background: rgba(255,255,255,0.08); color: var(--text-main); }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .address-bar {
            flex: 1; display: flex; align-items: center; gap: 10px;
            background: rgba(0,0,0,0.25); border-radius: 6px; padding: 0 12px; height: 32px;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .address-bar:focus-within { 
            border-color: var(--accent-blue); 
            background: rgba(0,0,0,0.4);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.15);
        }
        .address-bar .icon-svg { width: 14px; height: 14px; color: #4ade80; }
        .address-bar input { 
            flex: 1; background: transparent; border: none; 
            color: white; font-size: 13px; font-family: inherit;
        }
        .address-bar input::placeholder { color: var(--text-muted); }

        .content-area { flex: 1; background: #fff; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .content-area.dark { background: #1a1a24; }
        iframe { width: 100%; height: 100%; border: none; }
        
        .loading-overlay {
            position: absolute; inset: 0; background: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 16px;
            z-index: 5; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .loading-overlay.active { opacity: 1; pointer-events: auto; }
        .spinner { 
            width: 32px; height: 32px; 
            border: 3px solid #e5e7eb; border-top-color: var(--accent-blue); 
            border-radius: 50%; animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* === 记事本特定样式 === */
        .notepad-toolbar {
            padding: 8px 12px; background: rgba(0,0,0,0.2); 
            border-bottom: 1px solid var(--glass-border); display: flex; gap: 8px;
        }
        .notepad-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: var(--text-main); padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;
            transition: 0.2s;
        }
        .notepad-btn:hover { background: rgba(255,255,255,0.15); }
        .notepad-area {
            flex: 1; background: #1e1e1e; border: none; color: #e0e0e0;
            padding: 16px; font-family: 'Consolas', monospace; font-size: 14px; resize: none;
            line-height: 1.6;
        }

        /* === 任务栏 === */
        .taskbar {
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--taskbar-height);
            background: rgba(16, 16, 22, 0.92);
            backdrop-filter: blur(30px); border-top: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: space-between; z-index: 1000;
        }
        
        .start-btn {
            width: 48px; height: 100%; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background 0.15s;
        }
        .start-btn .icon-svg { width: 20px; height: 20px; color: var(--text-main); }
        .start-btn:hover { background: rgba(255,255,255,0.06); }
        
        .taskbar-apps { flex: 1; display: flex; height: 100%; padding-left: 8px; gap: 2px; }
        .taskbar-icon {
            width: 44px; height: 100%; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; transition: background 0.15s;
        }
        .taskbar-icon .icon-svg { width: 20px; height: 20px; color: rgba(255,255,255,0.85); }
        .taskbar-icon:hover { background: rgba(255,255,255,0.06); }
        .taskbar-icon.active::after {
            content: ''; position: absolute; bottom: 0;
            width: 16px; height: 3px; background: var(--accent-blue); border-radius: 2px;
        }

        .system-tray { display: flex; align-items: center; padding-right: 16px; gap: 6px; height: 100%; }
        .tray-icon { 
            width: 32px; height: 32px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background 0.15s;
        }
        .tray-icon .icon-svg { width: 16px; height: 16px; color: var(--text-muted); }
        .tray-icon:hover { background: rgba(255,255,255,0.06); }
        
        .clock { 
            padding: 4px 12px; font-size: 12px; text-align: right; 
            line-height: 1.4; cursor: pointer; border-radius: 4px;
        }
        .clock:hover { background: rgba(255,255,255,0.06); }
        .clock .time { font-weight: 500; }
        .clock .date { opacity: 0.7; font-size: 11px; }

        /* === 开始菜单 === */
        .start-menu {
            position: fixed; bottom: calc(var(--taskbar-height) + 12px); left: 12px;
            width: 340px; background: var(--glass-surface-light);
            backdrop-filter: blur(50px); border-radius: 10px; border: 1px solid var(--glass-border);
            padding: 20px; z-index: 2000; 
            transform: translateY(20px); opacity: 0; pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 16px 48px rgba(0,0,0,0.5);
        }
        .start-menu.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .start-menu-header { margin-bottom: 20px; }
        .start-menu-header h2 { 
            font-size: 14px; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
        }
        
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .menu-item {
            aspect-ratio: 1; background: rgba(255,255,255,0.04);
            border-radius: 8px; border: 1px solid transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; transition: all 0.15s;
        }
        .menu-item:hover { 
            background: rgba(255,255,255,0.08); 
            border-color: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }
        .menu-item .icon-svg { color: rgba(255,255,255,0.8); }
        .menu-item span { font-size: 11px; font-weight: 500; color: var(--text-muted); }

        /* === 右键菜单 === */
        .context-menu {
            position: fixed; min-width: 220px; background: var(--glass-surface-light);
            backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: 8px;
            padding: 6px; z-index: 3000; 
            opacity: 0; transform: scale(0.95); pointer-events: none;
            transition: all 0.12s ease; box-shadow: 0 12px 32px rgba(0,0,0,0.5);
        }
        .context-menu.open { opacity: 1; transform: scale(1); pointer-events: auto; }
        
        .context-item {
            padding: 10px 14px; border-radius: 5px; font-size: 13px;
            cursor: pointer; display: flex; align-items: center; gap: 12px;
            transition: background 0.1s;
        }
        .context-item .icon-svg { width: 16px; height: 16px; color: var(--text-muted); }
        .context-item:hover { background: var(--accent-blue); }
        .context-item:hover .icon-svg { color: white; }
        .context-divider { height: 1px; background: var(--glass-border); margin: 5px 0; }

        /* === 壁纸面板 === */
        .wallpaper-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
            width: 560px; max-height: 85vh; background: var(--glass-surface-light);
            border-radius: 12px; border: 1px solid var(--glass-border); z-index: 2500;
            opacity: 0; pointer-events: none; transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 24px 64px rgba(0,0,0,0.6);
            backdrop-filter: blur(50px);
        }
        .wallpaper-panel.open { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }
        
        .panel-header { 
            padding: 18px 22px; border-bottom: 1px solid var(--glass-border); 
            display: flex; align-items: center; justify-content: space-between; 
        }
        .panel-header h3 { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .panel-header h3 .icon-svg { width: 18px; height: 18px; color: var(--accent-blue); }
        .panel-close { 
            width: 30px; height: 30px; border-radius: 6px;
            background: transparent; border: none; color: var(--text-muted);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.15s;
        }
        .panel-close:hover { background: var(--win-close-red); color: white; }
        .panel-close .icon-svg { width: 14px; height: 14px; }
        
        .panel-content { padding: 22px; overflow-y: auto; flex: 1; }
        
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.15); border-radius: 10px;
            padding: 36px; text-align: center; margin-bottom: 24px;
            cursor: pointer; transition: all 0.2s;
        }
        .upload-area:hover { border-color: var(--accent-blue); background: rgba(0, 120, 212, 0.08); }
        .upload-area .icon-svg { width: 40px; height: 40px; color: var(--text-muted); margin-bottom: 12px; }
        .upload-area p { color: var(--text-muted); font-size: 13px; }
        .upload-area small { color: var(--text-muted); opacity: 0.6; font-size: 11px; margin-top: 6px; display: block; }
        
        .wp-section h4 { 
            font-size: 11px; font-weight: 600; color: var(--text-muted); 
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 14px;
        }
        .wp-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .wp-thumb { 
            aspect-ratio: 16/9; background-size: cover; background-position: center;
            border-radius: 8px; cursor: pointer; border: 2px solid transparent;
            transition: all 0.2s;
        }
        .wp-thumb:hover { transform: scale(1.03); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        .wp-thumb.active { border-color: var(--accent-blue); }

        /* === 设置窗口内容 === */
        .settings-content {
            padding: 28px;
            color: var(--text-main);
        }
        .settings-section {
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .settings-section h4 {
            font-size: 11px; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;
        }
        .settings-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .settings-item:last-child { border: none; }
        .settings-item label { font-size: 13px; color: var(--text-main); }
        .settings-item span { font-size: 12px; color: var(--text-muted); }

        .about-card {
            background: linear-gradient(135deg, rgba(0, 120, 212, 0.15), rgba(0, 212, 255, 0.08));
            border: 1px solid rgba(0, 120, 212, 0.2);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        .about-card .logo { 
            font-size: 48px; 
            font-weight: 700; 
            margin-bottom: 16px; 
            letter-spacing: -2px;
            background: linear-gradient(135deg, #0078d4, #00d4ff); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
        }
        .about-card h3 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .about-card p { font-size: 12px; color: var(--text-muted); line-height: 1.6; }

        /* === 文件夹窗口样式 === */
        .folder-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 14px; border-radius: 6px;
            cursor: pointer; transition: background 0.15s;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            user-select: none;
        }
        .folder-item:hover { background: rgba(255,255,255,0.08); }
        .folder-item:last-child { border: none; }
        .folder-item .icon-svg { color: var(--text-muted); }
        .folder-item span { font-size: 13px; }
        .folder-item.selected {
            background: rgba(0, 120, 212, 0.25);
            border-color: rgba(0, 120, 212, 0.5);
        }
        .folder-item.selected .icon-svg { color: #fff; }
        .folder-item.selected span { color: #fff; }

        /* === 文件夹窗口框选样式 === */
        .folder-selection-box {
            position: absolute;
            background: rgba(0, 120, 212, 0.2);
            border: 1px solid rgba(0, 120, 212, 0.6);
            pointer-events: none;
            display: none;
            z-index: 100;
        }

        /* === 解压进度条 === */
        .extract-progress {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--glass-surface-light); border-radius: 12px;
            padding: 30px 40px; z-index: 9999; text-align: center;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            backdrop-filter: blur(30px);
        }
        .extract-progress h4 { margin-bottom: 16px; font-size: 14px; }
        .extract-progress .bar { 
            width: 200px; height: 6px; background: rgba(255,255,255,0.1); 
            border-radius: 3px; overflow: hidden; 
        }
        .extract-progress .bar-fill { 
            height: 100%; background: var(--accent-blue); 
            transition: width 0.2s; width: 0%; 
        }
        .extract-progress p { margin-top: 12px; font-size: 12px; color: var(--text-muted); }

        /* === 日历面板 === */
        .calendar-panel {
            position: fixed; bottom: calc(var(--taskbar-height) + 12px); right: 12px;
            width: 320px; background: var(--glass-surface-light);
            backdrop-filter: blur(50px); border-radius: 10px; border: 1px solid var(--glass-border);
            padding: 20px; z-index: 2000;
            transform: translateY(20px); opacity: 0; pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 16px 48px rgba(0,0,0,0.5);
        }
        .calendar-panel.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .calendar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px;
        }
        .calendar-header h3 { font-size: 16px; font-weight: 600; }
        .calendar-nav { display: flex; gap: 8px; }
        .calendar-nav button {
            width: 28px; height: 28px; border-radius: 6px; border: none;
            background: rgba(255,255,255,0.08); color: var(--text-main);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.15s;
        }
        .calendar-nav button:hover { background: rgba(255,255,255,0.15); }
        
        .calendar-weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr);
            text-align: center; margin-bottom: 8px;
        }
        .calendar-weekdays span {
            font-size: 11px; color: var(--text-muted); font-weight: 600;
            padding: 8px 0;
        }
        
        .calendar-days {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            font-size: 13px; border-radius: 50%; cursor: pointer;
            transition: 0.15s;
        }
        .calendar-day:hover { background: rgba(255,255,255,0.1); }
        .calendar-day.other-month { color: var(--text-muted); opacity: 0.4; }
        .calendar-day.today { 
            background: var(--accent-blue); color: white; font-weight: 600;
        }
        .calendar-day.today:hover { background: #0066b8; }

        /* === 计算器样式 === */
        .calculator {
            padding: 16px; display: flex; flex-direction: column; gap: 12px; height: 100%;
        }
        .calc-display {
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 16px;
            text-align: right; min-height: 70px; display: flex; flex-direction: column; justify-content: flex-end;
        }
        .calc-display .expression { font-size: 14px; color: var(--text-muted); min-height: 20px; }
        .calc-display .result { font-size: 32px; font-weight: 300; color: var(--text-main); }
        
        .calc-buttons {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex: 1;
        }
        .calc-btn {
            border: none; border-radius: 8px; font-size: 18px; cursor: pointer;
            background: rgba(255,255,255,0.08); color: var(--text-main);
            transition: all 0.1s; display: flex; align-items: center; justify-content: center;
        }
        .calc-btn:hover { background: rgba(255,255,255,0.15); }
        .calc-btn:active { transform: scale(0.95); }
        .calc-btn.operator { background: rgba(0, 120, 212, 0.3); }
        .calc-btn.operator:hover { background: rgba(0, 120, 212, 0.5); }
        .calc-btn.equals { background: var(--accent-blue); }
        .calc-btn.equals:hover { background: #0066b8; }
        .calc-btn.clear { background: rgba(232, 17, 35, 0.3); }
        .calc-btn.clear:hover { background: rgba(232, 17, 35, 0.5); }

        /* === 画板样式 (完全重构版) === */
        .paint-app {
            display: flex; flex-direction: column; height: 100%;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        .paint-toolbar {
            padding: 10px 14px; background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
            touch-action: none;
            flex-shrink: 0;
        }
        .paint-tool-group {
            display: flex; align-items: center; gap: 6px;
        }
        .paint-tool-group label {
            font-size: 11px; color: var(--text-muted); text-transform: uppercase;
        }
        .paint-btn {
            width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05); color: var(--text-main);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.15s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .paint-btn:hover { background: rgba(255,255,255,0.15); }
        .paint-btn:active { transform: scale(0.95); }
        .paint-btn.active { background: var(--accent-blue); border-color: var(--accent-blue); }
        .paint-btn .icon-svg { width: 16px; height: 16px; }
        
        .color-picker {
            width: 32px; height: 32px; border: none; border-radius: 6px;
            cursor: pointer; padding: 0; background: transparent;
            touch-action: manipulation;
        }
        .color-picker::-webkit-color-swatch-wrapper { padding: 2px; }
        .color-picker::-webkit-color-swatch { border-radius: 4px; border: 1px solid var(--glass-border); }
        
        .brush-size {
            width: 80px; height: 6px; -webkit-appearance: none; background: rgba(255,255,255,0.2);
            border-radius: 3px; cursor: pointer;
        }
        .brush-size::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: var(--accent-blue); border-radius: 50%; cursor: pointer;
        }
        
        .paint-canvas-container {
            flex: 1; background: #ffffff; position: relative; overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
        }
        .paint-canvas {
            position: absolute; top: 0; left: 0; cursor: crosshair;
            touch-action: none;
        }
        
        /* 移动端画板工具栏适配 */
        @media (max-width: 768px) {
            .paint-toolbar {
                padding: 8px 10px;
                gap: 8px;
            }
            .paint-tool-group label {
                font-size: 10px;
            }
            .paint-btn {
                width: 36px;
                height: 36px;
            }
            .paint-btn .icon-svg {
                width: 18px;
                height: 18px;
            }
            .color-picker {
                width: 36px;
                height: 36px;
            }
            .brush-size {
                width: 60px;
            }
        }

        /* === V86 模拟器样式 === */
        .v86-app {
            display: flex; flex-direction: column; height: 100%;
        }
        .v86-toolbar {
            padding: 10px 14px; background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
        }
        .v86-screen-container {
            flex: 1; background: #000; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .v86-screen-container canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }
        .v86-log {
            position: absolute; bottom: 10px; left: 10px;
            font-size: 11px; color: #4ade80;
            background: rgba(0,0,0,0.7);
            padding: 6px 10px;
            border-radius: 4px;
            max-width: 300px;
            pointer-events: none;
        }
        .v86-screen-container.locked {
            cursor: none;
        }

        /* === 通知系统 (任务栏内嵌版 - 无限长度修复) === */
        #taskbar-notify-area {
            position: absolute;
            /* 锚定在右侧，紧贴系统托盘(WiFi等) */
            right: 140px;
            top: 6px;
            bottom: 6px;
            
            /* 核心修改：移除固定宽度限制，允许利用所有剩余空间 */
            width: auto;
            max-width: calc(100vw - 155px); /* 只有当长度超过屏幕剩余空间时才限制，防止覆盖开始按钮 */
            
            display: flex;
            align-items: center;
            justify-content: flex-end; /* 让短消息靠右，长消息向左延伸 */
            
            pointer-events: none;
            z-index: 1005;
            overflow: hidden; /* 隐藏滑出前的状态 */
        }
        
        /* 移动端适配：同样放宽限制 */
        @media (max-width: 600px) {
            #taskbar-notify-area {
                right: 90px; /* 移动端托盘区域较小 */
                max-width: calc(100vw - 100px); /* 利用移动端几乎所有宽度 */
            }
            .tb-notification {
                max-width: 100%; /* 确保胶囊自身不被限制 */
            }
        }

        /* 具体的通知胶囊 */
        .tb-notification {
            background: rgba(40, 40, 50, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 0 16px 0 12px;
            height: 36px;
            
            display: flex;
            align-items: center;
            gap: 10px;
            
            pointer-events: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            
            /* 动画保持不变：从右向左滑出 */
            transform: translateX(120%);
            opacity: 0;
            animation: slideLeftOut 0.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
            
            /* 核心修改：确保内部文本不换行，完整显示 */
            white-space: nowrap;
            flex-shrink: 0; /* 防止被挤压 */
        }

        /* 动画关键帧 */
        @keyframes slideLeftOut {
            0% { transform: translateX(120%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        /* 消失动画 */
        .tb-notification.hiding {
            animation: slideRightBack 0.4s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }
        @keyframes slideRightBack {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(120%); opacity: 0; }
        }

        /* 图标与文字样式 */
        .tb-notify-icon { width: 16px; height: 16px; flex-shrink: 0; }
        .tb-notify-icon.success { color: #4ade80; }
        .tb-notify-icon.error { color: #ef4444; }
        .tb-notify-icon.warning { color: #f59e0b; }
        .tb-notify-icon.info { color: var(--accent-blue); }

        .tb-notify-content {
            display: flex; flex-direction: column; justify-content: center;
            font-size: 12px; color: #fff;
            padding-right: 4px;
        }
        .tb-notify-title { font-weight: 600; margin-right: 6px; }
        .tb-notify-msg { opacity: 0.8; font-weight: 400; }
        .tb-notify-content.single .tb-notify-msg { display: none; }

        /* === 遮罩 & 调整手柄 === */
        .overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2400; 
            opacity: 0; pointer-events: none; transition: 0.25s; 
            backdrop-filter: blur(5px);
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        .resize-handle { position: absolute; z-index: 20; }
        .resize-handle.n { top: -3px; height: 6px; left:0; right:0; cursor: n-resize; }
        .resize-handle.s { bottom: -3px; height: 6px; left:0; right:0; cursor: s-resize; }
        .resize-handle.e { right: -3px; width: 6px; top:0; bottom:0; cursor: e-resize; }
        .resize-handle.w { left: -3px; width: 6px; top:0; bottom:0; cursor: w-resize; }
        .resize-handle.se { bottom: -3px; right: -3px; width: 16px; height: 16px; cursor: se-resize; }

        /* === 滚动条 === */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
      /* === 移动端适配 (核心样式) === */
        @media (max-width: 600px) {
            /* 桌面图标横向排列 */
            .desktop-icons {
                flex-direction: row; align-content: flex-start; flex-wrap: wrap;
                height: auto; bottom: 80px; top: 10px; left: 10px;
            }
            .desktop-icon { width: 72px; margin: 4px; }
            
            /* 窗口强制全屏 */
            .window:not(.minimized) {
                top: 0 !important; left: 0 !important;
                width: 100% !important; height: calc(100% - var(--taskbar-height)) !important;
                border-radius: 0 !important; transform: none !important;
            }
            
            /* 隐藏不需要的元素 */
            .resize-handle { display: none !important; }
            .win-btn:nth-child(2) { display: none; } /* 隐藏最大化按钮 */
            .clock .date { display: none; } /* 隐藏日期 */
            
            /* 增大触摸区域 */
            .start-menu { width: 95%; left: 2.5%; bottom: 60px; }
            .taskbar-icon { width: 42px; }
            .context-menu { min-width: 160px; padding: 8px; }
            .context-item { padding: 12px; font-size: 14px; }
        }

        /* 真正全屏状态 */
        .window.truly-fullscreen {
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            z-index: 9999 !important;
            border-radius: 0 !important;
        }

        /* 漫画全屏时：隐藏标题栏 */
        .window.truly-fullscreen.manga-full .title-bar { display: none; }
        
        /* 全屏时隐藏调整手柄 */
        .window.truly-fullscreen .resize-handle { display: none !important; }

        /* 漫画全屏时的紧急退出按钮 (仅在标题栏隐藏时显示) */
        .manga-exit-btn {
            position: fixed; top: 10px; right: 10px;
            width: 30px; height: 30px; background: rgba(0,0,0,0.5);
            color: white; border-radius: 50%; display: none;
            align-items: center; justify-content: center; cursor: pointer; z-index: 10001;
        }
        .window.truly-fullscreen.manga-full .manga-exit-btn { display: flex; }
    </style>
</head>
<body>


    <!-- SVG 滤镜 -->
    
   

    <!-- 壁纸 -->
    <div id="dynamic-bg" style="background-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=1920');"></div>
  

    <!-- 窗口吸附预览 -->
    <div id="snap-preview"></div>

    <!-- 桌面图标容器 --> 
     <div class="desktop" id="desktop"> 
         <!-- 新增：网格层和框选层 --> 
         <div class="desktop-grid-overlay" id="desktop-grid"></div> 
         <div class="selection-box" id="selection-box"></div> 
         
         <div class="desktop-icons" id="desktop-icons"></div> 
     </div>

    <!-- 任务栏 -->
    <div class="taskbar">
        <div class="start-btn" onclick="toggleStartMenu()">
            <svg class="icon-svg" viewBox="0 0 24 24">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
        </div>
        <div class="taskbar-apps">
            <div class="taskbar-icon" onclick="openBrowser()" title="浏览器">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
            </div>
            <div class="taskbar-icon" onclick="openNotepad()" title="记事本">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
            </div>
            <div class="taskbar-icon" onclick="openCalculator()" title="计算器">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <rect x="4" y="2" width="16" height="20" rx="2"/>
                    <line x1="8" y1="6" x2="16" y2="6"/>
                    <line x1="8" y1="10" x2="8" y2="10.01"/>
                    <line x1="12" y1="10" x2="12" y2="10.01"/>
                    <line x1="16" y1="10" x2="16" y2="10.01"/>
                    <line x1="8" y1="14" x2="8" y2="14.01"/>
                    <line x1="12" y1="14" x2="12" y2="14.01"/>
                    <line x1="16" y1="14" x2="16" y2="14.01"/>
                    <line x1="8" y1="18" x2="8" y2="18.01"/>
                    <line x1="12" y1="18" x2="12" y2="18.01"/>
                    <line x1="16" y1="18" x2="16" y2="18.01"/>
                </svg>
            </div>
            <div class="taskbar-icon" onclick="openPaint()" title="画板">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
            </div>
            <div class="taskbar-icon" onclick="openSettings()" title="设置">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            </div>
            <div class="taskbar-icon" onclick="openV86()" title="V86 虚拟机">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/>
                    <line x1="12" y1="17" x2="12" y2="21"/>
                    <path d="M6 8h2M6 12h2M10 8h8M10 12h8"/>
                </svg>
            </div>
        </div>

        <!-- 【新增】任务栏内通知区域 -->
        <div id="taskbar-notify-area"></div>

        <div class="system-tray">
            <div class="tray-icon">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <path d="M5 12.55a11 11 0 0 1 14.08 0"/>
                    <path d="M1.42 9a16 16 0 0 1 21.16 0"/>
                    <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
                    <circle cx="12" cy="20" r="1"/>
                </svg>
            </div>
            <div class="clock" id="clock" onclick="toggleCalendar()">
                <div class="time" id="time">12:00</div>
                <div class="date" id="date">2024/01/01</div>
            </div>
        </div>
    </div>

    <!-- 开始菜单 -->
    <div class="start-menu" id="start-menu">
        <div class="start-menu-header">
            <h2>Pinned</h2>
        </div>
        <div class="menu-grid">
            <div class="menu-item" onclick="openBrowser(); toggleStartMenu()">
                <svg class="icon-svg lg" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
                <span>Browser</span>
            </div>
            <div class="menu-item" onclick="openNotepad(); toggleStartMenu()">
                 <svg class="icon-svg lg" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                <span>Notepad</span>
            </div>
            <div class="menu-item" onclick="openCalculator(); toggleStartMenu()">
                <svg class="icon-svg lg" viewBox="0 0 24 24">
                    <rect x="4" y="2" width="16" height="20" rx="2"/>
                    <line x1="8" y1="6" x2="16" y2="6"/>
                    <line x1="8" y1="10" x2="8" y2="10.01"/>
                    <line x1="12" y1="10" x2="12" y2="10.01"/>
                    <line x1="16" y1="10" x2="16" y2="10.01"/>
                </svg>
                <span>Calculator</span>
            </div>
            <div class="menu-item" onclick="openPaint(); toggleStartMenu()">
                <svg class="icon-svg lg" viewBox="0 0 24 24">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
                <span>Paint</span>
            </div>
            <div class="menu-item" onclick="openSettings(); toggleStartMenu()">
                <svg class="icon-svg lg" viewBox="0 0 24 24">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <span>Settings</span>
            </div>
            <div class="menu-item" onclick="openWallpaperPanel(); toggleStartMenu()">
                <svg class="icon-svg lg" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="9" cy="9" r="2"/>
                    <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                </svg>
                <span>Wallpaper</span>
            </div>
            <div class="menu-item" onclick="resetSystem()">
                <svg class="icon-svg lg" viewBox="0 0 24 24">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
                <span>Reset</span>
            </div>
            <div class="menu-item" onclick="openV86(); toggleStartMenu()">
                <svg class="icon-svg lg" viewBox="0 0 24 24">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/>
                    <line x1="12" y1="17" x2="12" y2="21"/>
                    <path d="M6 8h2M6 12h2M10 8h8M10 12h8"/>
                </svg>
                <span>V86 VM</span>
            </div>
        </div>
    </div>

    <!-- 日历面板 -->
    <div class="calendar-panel" id="calendar-panel">
        <div class="calendar-header">
            <h3 id="calendar-title">2024年1月</h3>
            <div class="calendar-nav">
                <button onclick="changeMonth(-1)">
                    <svg class="icon-svg sm" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
                <button onclick="changeMonth(1)">
                    <svg class="icon-svg sm" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
                </button>
            </div>
        </div>
        <div class="calendar-weekdays">
            <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
        </div>
        <div class="calendar-days" id="calendar-days"></div>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="context-menu"></div>

    <!-- 壁纸面板 -->
    <div class="overlay" id="overlay" onclick="closePanel()"></div>
    <div class="wallpaper-panel" id="wallpaper-panel">
        <div class="panel-header">
            <h3>
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="9" cy="9" r="2"/>
                    <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                </svg>
                个性化
            </h3>
            <button class="panel-close" onclick="closePanel()">
                <svg class="icon-svg" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="panel-content">
            <div class="upload-area" id="drop-zone-wp" onclick="document.getElementById('file-input').click()">
                <svg class="icon-svg xl" viewBox="0 0 24 24">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p>点击上传或拖拽本地图片</p>
                <small>支持 JPG, PNG, WebP 格式</small>
            </div>
            <input type="file" id="file-input" hidden accept="image/*">
            
            <div class="wp-section">
                <h4>预设壁纸</h4>
                <div class="wp-grid" id="wp-grid"></div>
            </div>
        </div>
    </div>

    <!-- 窗口容器 -->
    <div id="windows-container"></div>

    <script>
        // === 系统内核与状态 ===
        const SYSTEM = {
            windows: [], 
            idCounter: 0, 
            startOpen: false,
            calendarOpen: false,
            fs: null,
            Buffer: null,
            mounted: false,
            desktopPath: '/desktop',
            configPath: '/system/config/wallpaper.cfg',
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedIcons: [],           
            iconPositions: {},           
            gridSize: 90, 
            iconPositionsPath: '/system/config/icon-positions.json' 
        };

        function toggleWinFullscreen(id, type) {
            const win = document.getElementById('win-' + id);
            if (!win) return;

            const isManga = type === 'manga';
            const isEntering = !win.classList.contains('truly-fullscreen');

            if (isEntering) {
                win.classList.add('truly-fullscreen');
                if (isManga) win.classList.add('manga-full');
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            } else {
                win.classList.remove('truly-fullscreen');
                win.classList.remove('manga-full');
                if (document.fullscreenElement) document.exitFullscreen();
            }
        }

        let currentDragFile = null;
        let dragFileReady = false;

        let longPressTimer = null;
        let longPressTriggered = false;

        const nativeDragHelper = document.createElement('div');
        nativeDragHelper.id = 'native-drag-helper';
        nativeDragHelper.draggable = true;
        nativeDragHelper.style.cssText = 'position:fixed;width:80px;height:90px;opacity:0;z-index:20000;pointer-events:auto;display:none;cursor:move;';
        document.body.appendChild(nativeDragHelper);

        function getClientXY(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        // 预设壁纸
        const wallpapers = [
            'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=1920',
            'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=1920',
            'https://images.unsplash.com/photo-1557683316-973673baf926?w=1920',
            'https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?w=1920',
            'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=1920',
            'https://images.unsplash.com/photo-1506318137071-a8bcbf6755dd?w=1920'
        ];

        // === 通知系统 (任务栏内嵌版) ===
        const Notify = {
            container: null,
            timer: null,
            
            init() {
                this.container = document.getElementById('taskbar-notify-area');
            },
            
            show({ title, message, type = 'info', duration = 3000 }) {
                // 如果容器没初始化
                if (!this.container) this.init();

                // 如果已有通知，先移除（造成一种切换的效果）
                if (this.container.children.length > 0) {
                    const old = this.container.firstElementChild;
                    old.classList.add('hiding');
                    setTimeout(() => old.remove(), 300);
                }
                
                // 清除之前的定时器
                if (this.timer) clearTimeout(this.timer);

                const icons = {
                    success: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
                    error: '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>',
                    warning: '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>',
                    info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
                };
                
                const el = document.createElement('div');
                el.className = 'tb-notification';
                // 点击可立即关闭
                el.onclick = () => {
                    el.classList.add('hiding');
                    setTimeout(() => el.remove(), 400);
                };

                // 简单的内容布局：图标 + 文本
                // 如果有 message，显示 "Title: Message"，否则只显示 Title
                el.innerHTML = `
                    <svg class="tb-notify-icon ${type}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        ${icons[type]}
                    </svg>
                    <div class="tb-notify-content ${!message ? 'single' : ''}">
                        <span>
                            <span class="tb-notify-title">${title}</span>
                            ${message ? `<span class="tb-notify-msg">${message}</span>` : ''}
                        </span>
                    </div>
                `;
                
                this.container.appendChild(el);
                
                // 自动滑回消失
                this.timer = setTimeout(() => {
                    if (el && el.parentElement) {
                        el.classList.add('hiding');
                        setTimeout(() => {
                            if (el.parentElement) el.remove();
                        }, 400);
                    }
                }, duration);
                
                return el;
            },
            
            success(title, message) { return this.show({ title, message, type: 'success' }); },
            error(title, message) { return this.show({ title, message, type: 'error' }); },
            warning(title, message) { return this.show({ title, message, type: 'warning' }); },
            info(title, message) { return this.show({ title, message, type: 'info' }); }
        };

        function addFolderToZipSync(zip, folderPath, callback) {
            SYSTEM.fs.readdir(folderPath, (err, files) => {
                if (err || files.length === 0) {
                    callback();
                    return;
                }
                let pending = files.length;
                files.forEach(file => {
                    const filePath = folderPath + '/' + file;
                    SYSTEM.fs.stat(filePath, (err, stats) => {
                        if (err) {
                            pending--;
                            if (pending === 0) callback();
                            return;
                        }
                        if (stats.isDirectory()) {
                            const subFolder = zip.folder(file);
                            addFolderToZipSync(subFolder, filePath, () => {
                                pending--;
                                if (pending === 0) callback();
                            });
                        } else {
                            SYSTEM.fs.readFile(filePath, (err, data) => {
                                if (!err) zip.file(file, data);
                                pending--;
                                if (pending === 0) callback();
                            });
                        }
                    });
                });
            });
        }

        function preloadFileForDrag(filepath, filename, callback) {
            SYSTEM.fs.stat(filepath, (err, stats) => {
                if (err) {
                    callback(false);
                    return;
                }
                if (stats.isDirectory()) {
                    const zip = new JSZip();
                    const rootFolder = zip.folder(filename);
                    addFolderToZipSync(rootFolder, filepath, () => {
                        zip.generateAsync({ type: 'blob', compression: 'DEFLATE' })
                        .then(blob => {
                            currentDragFile = {
                                blob: blob,
                                filename: filename + '.zip',
                                originalName: filename
                            };
                            dragFileReady = true;
                            console.log('✓ 文件已准备: ' + filename);
                            callback(true);
                        });
                    });
                } else {
                    SYSTEM.fs.readFile(filepath, (err, data) => {
                        if (err) {
                            callback(false);
                            return;
                        }
                        currentDragFile = {
                            blob: new Blob([data]),
                            filename: filename,
                            originalName: filename
                        };
                        dragFileReady = true;
                        console.log('✓ 文件已准备: ' + filename);
                        callback(true);
                    });
                }
            });
        }

        function handleNativeDragStart(e, filename) {
            if (!dragFileReady || !currentDragFile) {
                e.dataTransfer.setData('text/plain', filename);
                return;
            }
            const blob = currentDragFile.blob;
            const finalFilename = currentDragFile.filename;
            const file = new File([blob], finalFilename, {
                type: 'application/octet-stream',
                lastModified: Date.now()
            });
            e.dataTransfer.effectAllowed = 'copyMove';
            if (e.dataTransfer.items && e.dataTransfer.items.add) {
                e.dataTransfer.items.add(file);
            }
            const url = URL.createObjectURL(blob);
            e.dataTransfer.setData('DownloadURL', 'application/octet-stream:' + finalFilename + ':' + url);
            e.dataTransfer.setData('text/plain', JSON.stringify({
                filename: currentDragFile.originalName,
                srcPath: SYSTEM.desktopPath + '/' + currentDragFile.originalName
            }));
            e.target.style.opacity = '0.4';
            console.log('→ 拖拽到真实桌面');
        }

        function handleNativeDragEnd(e) {
            e.target.style.opacity = '1';
            dragFileReady = false;
            currentDragFile = null;
        }

        // === 初始化内核 (BrowserFS) ===
        function initKernel() {
            if (typeof BrowserFS === 'undefined') {
                console.error("Error: FS Lib failed to load.");
                return;
            }

            BrowserFS.install(window);
            BrowserFS.configure({
                fs: "MountableFileSystem",
                options: { '/': { fs: "IndexedDB", options: { storeName: 'JISHENG_OS_V3' } } }
            }, function(e) {
                if (e) {
                    console.error(e);
                    return;
                }
                SYSTEM.fs = require('fs');
                SYSTEM.Buffer = require('buffer').Buffer;
                SYSTEM.mounted = true;
                
                checkSystemFiles();
            });
        }

        function checkSystemFiles() {
            const fs = SYSTEM.fs;
            const dirs = ['/system', '/system/config', '/desktop', '/documents'];
            let i = 0;
            function next() {
                if (i >= dirs.length) { loadUserConfig(); return; }
                const dir = dirs[i++];
                fs.exists(dir, (exists) => {
                    if (!exists) fs.mkdir(dir, next);
                    else next();
                });
            }
            next();
        }

        function loadUserConfig() {
            SYSTEM.fs.readFile(SYSTEM.configPath, 'utf8', (err, data) => {
                if (!err && data) setBg(data, false);
                else setBg(wallpapers[4], false);
                
                refreshDesktop();
                renderCalendar();
                Notify.init();
                initGlobalUploadInputs();
                Notify.success('欢迎回来', 'JISHENG OS 已准备就绪');
            });
        }

        // === 0. 初始化全局上传控件 (文件 & 文件夹) ===
        function initGlobalUploadInputs() {
            // 1. 创建上传文件控件
            if(!document.getElementById('global-upload-file')) {
                const inputFile = document.createElement('input');
                inputFile.type = 'file';
                inputFile.id = 'global-upload-file';
                inputFile.multiple = true; // 支持多选
                inputFile.hidden = true;
                inputFile.onchange = (e) => handleUploadFiles(e.target.files);
                document.body.appendChild(inputFile);
            }

            // 2. 创建上传文件夹控件
            if(!document.getElementById('global-upload-folder')) {
                const inputFolder = document.createElement('input');
                inputFolder.type = 'file';
                inputFolder.id = 'global-upload-folder';
                inputFolder.webkitdirectory = true; // 关键：允许选择文件夹
                inputFolder.hidden = true;
                inputFolder.onchange = (e) => handleUploadFiles(e.target.files);
                document.body.appendChild(inputFolder);
            }
        }

        // 处理 Input 选择的文件 (扁平化列表，包含路径信息)
        function handleUploadFiles(fileList) {
            if (!fileList || fileList.length === 0) return;
            
            let count = 0;
            const total = fileList.length;

            Array.from(fileList).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const buffer = SYSTEM.Buffer.from(e.target.result);
                    // 如果是上传文件夹，file.webkitRelativePath 会包含 "Folder/Sub/file.txt"
                    // 如果是上传文件，通常只是 "file.txt"
                    const relPath = file.webkitRelativePath || file.name;
                    const fullPath = SYSTEM.desktopPath + '/' + relPath;
                    
                    // 确保父目录存在
                    ensureDir(fullPath.substring(0, fullPath.lastIndexOf('/'))).then(() => {
                        SYSTEM.fs.writeFile(fullPath, buffer, () => {
                            count++;
                            // 简单的防抖刷新，或者每完成一个就刷新
                            if(count === total || count % 5 === 0) refreshDesktop();
                            if(count === total) Notify.success('上传完成', `成功导入 ${total} 个项目`);
                        });
                    });
                };
                reader.readAsArrayBuffer(file);
            });
            
            // 清空 value 以便下次能选同一个文件
            document.getElementById('global-upload-file').value = '';
            document.getElementById('global-upload-folder').value = '';
        }

        // === 时钟 ===
        setInterval(() => {
            const d = new Date();
            document.getElementById('time').innerText = d.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('date').innerText = d.toLocaleDateString('zh-CN');
        }, 1000);

        // === 日历功能 ===
        function toggleCalendar() {
            SYSTEM.calendarOpen = !SYSTEM.calendarOpen;
            document.getElementById('calendar-panel').classList.toggle('open', SYSTEM.calendarOpen);
            if(SYSTEM.calendarOpen) {
                SYSTEM.startOpen = false;
                document.getElementById('start-menu').classList.remove('open');
                renderCalendar();
            }
        }

        function changeMonth(delta) {
            SYSTEM.currentMonth += delta;
            if(SYSTEM.currentMonth > 11) { SYSTEM.currentMonth = 0; SYSTEM.currentYear++; }
            if(SYSTEM.currentMonth < 0) { SYSTEM.currentMonth = 11; SYSTEM.currentYear--; }
            renderCalendar();
        }

        function renderCalendar() {
            const year = SYSTEM.currentYear;
            const month = SYSTEM.currentMonth;
            const today = new Date();
            
            document.getElementById('calendar-title').innerText = `${year}年${month + 1}月`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            let html = '';
            
            for(let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">${daysInPrevMonth - i}</div>`;
            }
            
            for(let i = 1; i <= daysInMonth; i++) {
                const isToday = (i === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                html += `<div class="calendar-day${isToday ? ' today' : ''}">${i}</div>`;
            }
            
            const remaining = 42 - (firstDay + daysInMonth);
            for(let i = 1; i <= remaining; i++) {
                html += `<div class="calendar-day other-month">${i}</div>`;
            }
            
            document.getElementById('calendar-days').innerHTML = html;
        }

        // === 桌面渲染 ===
        // ===============================================
        // 新增/替换的核心交互逻辑 (拖拽、框选、右键、文件夹)
        // ===============================================

        // 1. 读取位置配置
        function loadIconPositions(callback) {
            if(!SYSTEM.mounted) { callback(); return; }
            SYSTEM.fs.readFile(SYSTEM.iconPositionsPath, 'utf8', (err, data) => {
                if(!err && data) {
                    try { SYSTEM.iconPositions = JSON.parse(data); } catch(e) { SYSTEM.iconPositions = {}; }
                }
                callback();
            });
        }

        function saveIconPositions() {
            if(!SYSTEM.mounted) return;
            SYSTEM.fs.writeFile(SYSTEM.iconPositionsPath, JSON.stringify(SYSTEM.iconPositions), () => {});
        }

        // 2. 替换原有的 refreshDesktop (改为绝对定位布局)
        function refreshDesktop() {
            const container = document.getElementById('desktop-icons');
            container.innerHTML = '';
            
            loadIconPositions(() => {
                // 系统固定应用
                const systemApps = [
                    { id: 'app-browser', name: '浏览器', action: 'openBrowser()', icon: '<circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>' },
                    { id: 'app-notepad', name: '记事本', action: 'openNotepad()', icon: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line>' },
                    { id: 'app-calc', name: '计算器', action: 'openCalculator()', icon: '<rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="8" y2="10.01"/><line x1="12" y1="10" x2="12" y2="10.01"/><line x1="16" y1="10" x2="16" y2="10.01"/>' },
                    { id: 'app-paint', name: '画板', action: 'openPaint()', icon: '<path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><circle cx="11" cy="11" r="2"/>' },
                    { id: 'app-settings', name: '系统设置', action: 'openSettings()', icon: '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>' }
                ];

                // 排列逻辑
                const maxPerColumn = Math.floor((window.innerHeight - 80) / SYSTEM.gridSize);
                let index = 0;

                const getNextPos = () => {
                    const col = Math.floor(index / maxPerColumn);
                    const row = index % maxPerColumn;
                    index++;
                    return { x: 24 + col * SYSTEM.gridSize, y: 24 + row * SYSTEM.gridSize };
                };

                // 添加 V86 到系统应用列表
                systemApps.push({
                    id: 'app-v86',
                    name: 'V86 虚拟机',
                    action: 'openV86()',
                    icon: '<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/><path d="M6 8h2M6 12h2M10 8h8M10 12h8"/>'
                });

                // 渲染系统应用
                systemApps.forEach(app => {
                    const defaultPos = getNextPos();
                    const pos = SYSTEM.iconPositions[app.id] || defaultPos;
                    container.appendChild(createIconElement(app.id, app.name, app.icon, app.action, pos));
                });

                // 渲染用户文件
                if(SYSTEM.mounted) {
                    SYSTEM.fs.readdir(SYSTEM.desktopPath, (err, files) => {
                        if(err) return;
                        files.forEach(file => {
                            const fileId = 'file-' + file;
                            const defaultPos = getNextPos();
                            const pos = SYSTEM.iconPositions[fileId] || defaultPos;
                            
                            let iconSvg = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>';
                            let type = 'file';

                            if(file.match(/\.(jpg|png|gif|webp)$/i)) {
                                iconSvg = '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>';
                            } else if(file.match(/\.txt$/i)) {
                                iconSvg = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line>';
                            } else if(file.match(/\.zip$/i)) {
                                iconSvg = '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2v11z"/><path d="M12 10v4"/><path d="M12 14l2-2"/>';
                            } else if(isArchiveFile(file)) {
                                iconSvg = '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2v11z"/><path d="M12 10v4"/><path d="M12 14l2-2"/>';
                            } else if(file.match(/\.html?$/i)) {
                                iconSvg = '<circle cx="12" cy="12" r="10"/><path d="M2 12h20"/>';
                            }

                            // 异步检查是否为文件夹
                            SYSTEM.fs.stat(SYSTEM.desktopPath + '/' + file, (err, stats) => {
                                if(!err && stats.isDirectory()) {
                                    iconSvg = '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2v11z"/>';
                                    container.appendChild(createIconElement(fileId, file, iconSvg, `openFolderWindow('${file}')`, pos, 'folder', file));
                                } else {
                                    container.appendChild(createIconElement(fileId, file, iconSvg, `openFile('${file}')`, pos, 'file', file));
                                }
                            });
                        });
                    });
                }
            });
            
            initDesktopEvents();
        }

        // 3. 创建图标 DOM 元素 (绑定交互事件)
        function createIconElement(id, name, iconSvg, action, pos, type = 'app', filename = null) {
            const el = document.createElement('div');
            el.className = 'desktop-icon';
            el.id = id;
            if(filename) el.dataset.filename = filename;
            el.style.left = pos.x + 'px';
            el.style.top = pos.y + 'px';
            
            el.innerHTML = `<svg class="icon-svg xl" viewBox="0 0 24 24">${iconSvg}</svg><div class="label">${name}</div>`;
            
            const handleStart = (e) => {
                if(e.button === 2) return;
                
                e.stopPropagation();
                
                if(e.ctrlKey) {
                    toggleIconSelection(el);
                } else if(!SYSTEM.selectedIcons.includes(id)) {
                    clearSelection();
                    selectIcon(el);
                }
                
                if(!longPressTriggered) {
                    startIconDrag(e, el);
                } else {
                    startIconDrag(e, el, true);
                }
            };

            el.onmousedown = handleStart;
            el.ontouchstart = (e) => {
                handleStart(e); 
            };

            if(filename) {
                el.setAttribute('draggable', 'true');
                el.onmouseenter = () => {
                    if(filename) {
                        preloadFileForDrag(SYSTEM.desktopPath + '/' + filename, filename, () => {});
                    }
                };
                el.ondragstart = (e) => {
                    e.stopPropagation();
                    if(longPressTriggered) {
                        handleNativeDragStart(e, filename);
                    } else {
                        e.preventDefault();
                    }
                };
                el.ondragend = (e) => {
                    handleNativeDragEnd(e);
                    el.style.outline = 'none';
                };
            }

            el.oncontextmenu = (e) => {
                e.preventDefault(); e.stopPropagation();
                if(!SYSTEM.selectedIcons.includes(id)) {
                    clearSelection();
                    selectIcon(el);
                }
                const pos = getClientXY(e);
                showIconContextMenu(pos.x, pos.y);
            };

            el.ondblclick = () => { eval(action); clearSelection(); };
            
            return el;
        }

        // 4. 图标拖拽逻辑 (Windows 风格)
        let dragState = null;
        function startIconDrag(e, el, isNativeDragMode = false) {
            if (e.touches && e.touches.length > 1) return;

            const pos = getClientXY(e);

            const rect = el.getBoundingClientRect();
            dragState = {
                startX: pos.x, startY: pos.y,
                icons: [], hasMoved: false,
                el: el,
                isNativeDragMode: isNativeDragMode
            };
            
            SYSTEM.selectedIcons.forEach(id => {
                const icon = document.getElementById(id);
                if(icon) {
                    dragState.icons.push({
                        el: icon, id: id,
                        startLeft: icon.offsetLeft, startTop: icon.offsetTop
                    });
                }
            });

            longPressTriggered = false;
            if(longPressTimer) clearTimeout(longPressTimer);
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                if(dragState && dragState.el && el.dataset.filename) {
                    nativeDragHelper.style.display = 'block';
                    nativeDragHelper.style.left = (pos.x - 40) + 'px';
                    nativeDragHelper.style.top = (pos.y - 45) + 'px';
                    
                    nativeDragHelper.ondragstart = (ev) => {
                        handleNativeDragStart(ev, el.dataset.filename);
                    };
                    
                    dragState.el.style.outline = '2px solid rgba(0, 120, 212, 0.5)';
                }
            }, 400);

            if(!isNativeDragMode) {
                document.addEventListener('mousemove', onIconDragMove);
                document.addEventListener('mouseup', onIconDragEnd);
                document.addEventListener('touchmove', onIconDragMove, { passive: false });
                document.addEventListener('touchend', onIconDragEnd);
            } else {
                document.addEventListener('mouseup', onIconDragEnd);
                document.addEventListener('touchend', onIconDragEnd);
            }
        }

        function onIconDragMove(e) {
            if(!dragState) return;
            
            if(e.type === 'touchmove') e.preventDefault();

            const pos = getClientXY(e);
            const dx = pos.x - dragState.startX;
            const dy = pos.y - dragState.startY;

            if(!dragState.hasMoved && (Math.abs(dx) > 3 || Math.abs(dy) > 3)) {
                dragState.hasMoved = true;
                dragState.icons.forEach(i => i.el.classList.add('dragging'));
            }

            if(dragState.hasMoved) {
                requestAnimationFrame(() => {
                    if(!dragState) return;
                    dragState.icons.forEach(i => {
                        i.el.style.left = (i.startLeft + dx) + 'px';
                        i.el.style.top = (i.startTop + dy) + 'px';
                    });
                });
            }
        }

        function onIconDragEnd(e) {
            nativeDragHelper.style.display = 'none';
            
            document.removeEventListener('mousemove', onIconDragMove);
            document.removeEventListener('mouseup', onIconDragEnd);
            document.removeEventListener('touchmove', onIconDragMove);
            document.removeEventListener('touchend', onIconDragEnd);
            
            if(longPressTimer) clearTimeout(longPressTimer);
            longPressTriggered = false;

            if(dragState && !dragState.isNativeDragMode && dragState.hasMoved) {
                const maxW = window.innerWidth - 90;
                const maxH = window.innerHeight - 100;
                
                dragState.icons.forEach(i => {
                    i.el.classList.remove('dragging');
                    i.el.style.outline = 'none';
                    let x = Math.round(i.el.offsetLeft / SYSTEM.gridSize) * SYSTEM.gridSize + 24;
                    let y = Math.round(i.el.offsetTop / SYSTEM.gridSize) * SYSTEM.gridSize + 24;
                    
                    x = Math.max(24, Math.min(x, maxW));
                    y = Math.max(24, Math.min(y, maxH));

                    i.el.style.transition = 'all 0.2s';
                    i.el.style.left = x + 'px';
                    i.el.style.top = y + 'px';
                    setTimeout(() => i.el.style.transition = '', 200);

                    SYSTEM.iconPositions[i.id] = {x, y};
                });
                saveIconPositions();
            }
            dragState = null;
        }

        // 5. 框选与选择逻辑
        function initDesktopEvents() {
            const desktop = document.getElementById('desktop');
            const box = document.getElementById('selection-box');
            let isSelecting = false, startX, startY;

            const handleStart = (e) => {
                if(e.target !== desktop && e.target !== document.getElementById('desktop-icons')) return;
                if(e.button === 2) return;

                clearSelection();
                isSelecting = true;
                
                const pos = getClientXY(e);
                startX = pos.x; 
                startY = pos.y;
                
                box.style.display = 'block';
                box.style.width = '0'; box.style.height = '0';
                box.style.left = startX + 'px'; box.style.top = startY + 'px';
            };

            const handleMove = (e) => {
                if(!isSelecting) return;
                
                if(e.type === 'touchmove') e.preventDefault();
                
                const pos = getClientXY(e);
                const curX = pos.x; 
                const curY = pos.y;
                
                const left = Math.min(startX, curX), top = Math.min(startY, curY);
                const width = Math.abs(startX - curX), height = Math.abs(startY - curY);
                
                box.style.left = left + 'px'; box.style.top = top + 'px';
                box.style.width = width + 'px'; box.style.height = height + 'px';

                document.querySelectorAll('.desktop-icon').forEach(icon => {
                    const r = icon.getBoundingClientRect();
                    const intersect = !(r.right < left || r.left > left+width || r.bottom < top || r.top > top+height);
                    if(intersect) selectIcon(icon); else deselectIcon(icon);
                });
            };

            const handleEnd = () => {
                isSelecting = false; 
                box.style.display = 'none';
            };

            desktop.onmousedown = handleStart;
            desktop.ontouchstart = handleStart;

            document.addEventListener('mousemove', handleMove);
            document.addEventListener('touchmove', handleMove, {passive: false});

            document.addEventListener('mouseup', handleEnd);
            document.addEventListener('touchend', handleEnd);
            
            desktop.ondragover = e => e.preventDefault();
            desktop.ondrop = async (e) => {
                e.preventDefault();

                // === 定义防抖刷新函数 (核心修复) ===
                // 只有当文件停止写入 200ms 后，才执行一次刷新
                let refreshTimer = null;
                const debouncedRefresh = () => {
                    if (refreshTimer) clearTimeout(refreshTimer);
                    refreshTimer = setTimeout(() => {
                        refreshDesktop();
                        Notify.success('导入完成', '所有文件已更新');
                    }, 200);
                };

                // 1. 处理系统内部文件拖拽
                const dragData = e.dataTransfer.getData('text/plain');
                if (dragData) {
                    try {
                        const { srcPath, filename } = JSON.parse(dragData);
                        if (srcPath && filename) {
                            SYSTEM.fs.readFile(srcPath, (err, data) => {
                                if (!err) {
                                    SYSTEM.fs.writeFile(SYSTEM.desktopPath + '/' + filename, data, () => {
                                        SYSTEM.iconPositions['file-' + filename] = { x: e.clientX - 40, y: e.clientY - 40 };
                                        saveIconPositions();
                                        refreshDesktop(); // 单个文件可以直接刷新
                                    });
                                }
                            });
                        }
                    } catch (e) { }
                    return;
                }

                // 2. 处理外部拖拽 (应用防抖逻辑)
                const items = e.dataTransfer.items;
                if (items && items.length > 0) {
                    let processCount = 0;
                    
                    // 递归扫描函数
                    const traverseFileTree = (item, path) => {
                        path = path || "";
                        if (item.isFile) {
                            item.file((file) => {
                                const reader = new FileReader();
                                reader.onload = (ev) => {
                                    const buffer = SYSTEM.Buffer.from(ev.target.result);
                                    const fullPath = SYSTEM.desktopPath + (path ? '/' + path : '') + '/' + file.name;
                                    const parentDir = fullPath.substring(0, fullPath.lastIndexOf('/'));
                                    
                                    ensureDir(parentDir).then(() => {
                                        SYSTEM.fs.writeFile(fullPath, buffer, () => {
                                            processCount++;
                                            // 如果是根目录文件，记录位置
                                            if(!path) {
                                                SYSTEM.iconPositions['file-' + file.name] = { x: e.clientX - 40 + (processCount*10), y: e.clientY - 40 + (processCount*10) };
                                                saveIconPositions();
                                            }
                                            
                                            // 【重点】这里不再直接调用 refreshDesktop()
                                            // 而是调用防抖函数，防止图标重叠变粗
                                            debouncedRefresh();
                                        });
                                    });
                                };
                                reader.readAsArrayBuffer(file);
                            });
                        } else if (item.isDirectory) {
                            const dirPath = (path ? path + '/' : '') + item.name;
                            const fullDirPath = SYSTEM.desktopPath + '/' + dirPath;
                            
                            if(!path) {
                                SYSTEM.iconPositions['file-' + item.name] = { x: e.clientX - 40, y: e.clientY - 40 };
                                saveIconPositions();
                            }

                            ensureDir(fullDirPath).then(() => {
                                // 文件夹创建后也调用防抖刷新
                                debouncedRefresh();
                                
                                const dirReader = item.createReader();
                                const readEntries = () => {
                                    dirReader.readEntries((entries) => {
                                        if (entries.length > 0) {
                                            entries.forEach((entry) => traverseFileTree(entry, dirPath));
                                            readEntries();
                                        }
                                    });
                                };
                                readEntries();
                            });
                        }
                    };

                    for (let i = 0; i < items.length; i++) {
                        const item = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
                        if (item) traverseFileTree(item);
                    }
                    
                    Notify.info('正在处理', '开始导入文件结构...');
                }
            };
        }

        // 辅助函数：选择/取消选择
        function selectIcon(el) {
            if(!SYSTEM.selectedIcons.includes(el.id)) {
                SYSTEM.selectedIcons.push(el.id);
                el.classList.add('selected');
            }
        }
        function deselectIcon(el) {
            const idx = SYSTEM.selectedIcons.indexOf(el.id);
            if(idx > -1) { SYSTEM.selectedIcons.splice(idx, 1); el.classList.remove('selected'); }
        }
        function toggleIconSelection(el) {
            if(SYSTEM.selectedIcons.includes(el.id)) deselectIcon(el); else selectIcon(el);
        }
        function clearSelection() {
            SYSTEM.selectedIcons.forEach(id => document.getElementById(id)?.classList.remove('selected'));
            SYSTEM.selectedIcons = [];
        }

        // 6. 新的右键菜单逻辑 (支持多选)
        function showIconContextMenu(x, y) {
            const cm = document.getElementById('context-menu');
            const count = SYSTEM.selectedIcons.length;
            const isFile = count === 1 && SYSTEM.selectedIcons[0].startsWith('file-');
            
            let html = '';
            
            if(count > 1) {
                html = `<div class="context-item" onclick="deleteSelected(); closeCtx()" style="color:var(--win-close-red)">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    <span>删除选中 (${count})</span>
                </div>`;
            } else if(isFile) {
                const id = SYSTEM.selectedIcons[0];
                const filename = document.getElementById(id).dataset.filename;
                html = `
                    <div class="context-item" onclick="openFile('${filename}'); closeCtx()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg><span>打开</span>
                    </div>
                    ${isArchiveFile(filename) ? `<div class="context-item" onclick="extractZip('${filename}'); closeCtx()"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 8v13H3V8"/></svg><span>解压</span></div>` : ''}
                    <div class="context-divider"></div>
                    <div class="context-item" onclick="renameDesktopFile('${filename}'); closeCtx()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                        <span>重命名</span>
                    </div>
                    <div class="context-item" onclick="deleteFile('${filename}'); closeCtx()" style="color:var(--win-close-red)">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/></svg><span>删除</span>
                    </div>
                `;
            } else {
                // 应用图标右键
                const id = SYSTEM.selectedIcons[0];
                html = `<div class="context-item" onclick="document.getElementById('${id}').ondblclick(); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg><span>打开</span>
                </div>`;
            }
            
            cm.innerHTML = html;
            showCtx(x, y);
        }

        function deleteSelected() {
            if(!confirm('确定删除选中项吗？')) return;
            const files = SYSTEM.selectedIcons.filter(id => id.startsWith('file-'))
                          .map(id => document.getElementById(id).dataset.filename);
            
            let count = 0;
            files.forEach(f => {
                const path = SYSTEM.desktopPath + '/' + f;
                SYSTEM.fs.stat(path, (err, stats) => {
                    const cb = () => { count++; if(count===files.length) { refreshDesktop(); Notify.success('已删除'); } };
                    if(stats.isDirectory()) deleteFolderRecursive(path, cb); else SYSTEM.fs.unlink(path, cb);
                });
            });
        }

        // 7. 替换 openFolderWindow (支持从文件夹拖出、框选、多选)
        function openFolderWindow(folderName) {
            const path = SYSTEM.desktopPath + '/' + folderName;
            SYSTEM.fs.readdir(path, (err, files) => {
                if(err) { Notify.error('错误', err.message); return; }
                
                const windowId = 'folder-' + Date.now();
                
                let content = files.length === 0 
                    ? '<div style="padding:40px;text-align:center;color:#888">文件夹为空</div>'
                    : files.map(file => {
                        let icon = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>';
                        if(file.match(/\.(jpg|png|gif|webp)$/i)) icon = '<rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="9" cy="9" r="2"/>';
                        if(isArchiveFile(file)) icon = '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2v11z"/><path d="M12 10v4"/><path d="M12 14l2-2"/>';
                        
                        return `
                            <div class="folder-item" data-filename="${file}" data-path="${path}/${file}"
                                 ondblclick="openFileFromPath('${path}/${file}', '${file}')"
                                 onmousedown="handleFolderItemMouseDown(event, '${windowId}')"
                                 oncontextmenu="handleFolderItemContextMenu(event, '${windowId}', '${file}', '${path}/${file}')">
                                <svg class="icon-svg" viewBox="0 0 24 24">${icon}</svg>
                                <span>${file}</span>
                            </div>
                        `;
                    }).join('');
                
                const winId = createWindow({
                    title: folderName,
                    iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2v11z"/></svg>',
                    width: 500, height: 400,
                    content: `
                        <div class="content-area dark" id="folder-content-${windowId}" style="padding:8px;overflow-y:auto;position:relative;height:100%">
                            <div class="folder-selection-box" id="folder-selection-${windowId}"></div>
                            ${content}
                        </div>
                    `,
                    onInit: (w, id) => {
                        initFolderSelection(windowId);
                    }
                });
            });
        }

        // 文件夹窗口框选逻辑
        function initFolderSelection(windowId) {
            const contentArea = document.getElementById('folder-content-' + windowId);
            const selectionBox = document.getElementById('folder-selection-' + windowId);
            let isSelecting = false, startX, startY;
            
            contentArea.onmousedown = (e) => {
                if(e.button !== 0) return;
                
                if(isSelecting) return;
                
                if(e.target.closest('.folder-item')) return;
                
                e.preventDefault();
                e.stopPropagation();
                clearFolderSelection(windowId);
                isSelecting = true;
                contentArea.dataset.isSelecting = 'true';
                
                const rect = contentArea.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                
                selectionBox.style.display = 'block';
                selectionBox.style.width = '0';
                selectionBox.style.height = '0';
                selectionBox.style.left = startX + 'px';
                selectionBox.style.top = startY + 'px';
            };
            
            contentArea.onmousemove = (e) => {
                if(!isSelecting) return;
                
                const rect = contentArea.getBoundingClientRect();
                const curX = e.clientX - rect.left;
                const curY = e.clientY - rect.top;
                
                const left = Math.min(startX, curX);
                const top = Math.min(startY, curY);
                const width = Math.abs(startX - curX);
                const height = Math.abs(startY - curY);
                
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
                
                const items = contentArea.querySelectorAll('.folder-item');
                items.forEach(item => {
                    const itemRect = item.getBoundingClientRect();
                    const contentRect = contentArea.getBoundingClientRect();
                    
                    const itemLeft = itemRect.left - contentRect.left;
                    const itemTop = itemRect.top - contentRect.top;
                    const itemRight = itemLeft + itemRect.width;
                    const itemBottom = itemTop + itemRect.height;
                    
                    const intersect = !(itemRight < left || itemLeft > left + width || 
                                       itemBottom < top || itemTop > top + height);
                    
                    if(intersect) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            };
            
            contentArea.onmouseup = () => {
                isSelecting = false;
                contentArea.dataset.isSelecting = 'false';
                selectionBox.style.display = 'none';
            };
            
            contentArea.onmouseleave = () => {
                isSelecting = false;
                contentArea.dataset.isSelecting = 'false';
                selectionBox.style.display = 'none';
            };
        }

        function handleFolderItemMouseDown(e, windowId) {
            if(e.button !== 0) return;
            
            const contentArea = document.getElementById('folder-content-' + windowId);
            if(!contentArea) return;
            
            if(contentArea.dataset.isSelecting === 'true') return;
            
            const item = e.currentTarget;
            
            if(e.ctrlKey) {
                item.classList.toggle('selected');
            } else if(!item.classList.contains('selected')) {
                clearFolderSelection(windowId);
                item.classList.add('selected');
            }
            
            setupFolderItemDrag(e, windowId);
        }

        function handleFolderItemContextMenu(e, windowId, filename, fullPath) {
            e.preventDefault();
            e.stopPropagation();
            
            const contentArea = document.getElementById('folder-content-' + windowId);
            if(!contentArea) return;
            
            const item = e.currentTarget;
            if(!item.classList.contains('selected')) {
                clearFolderSelection(windowId);
                item.classList.add('selected');
            }
            
            const selectedItems = Array.from(contentArea.querySelectorAll('.folder-item.selected'));
            const count = selectedItems.length;
            
            const cm = document.getElementById('context-menu');
            let html = '';
            
            if(count > 1) {
                html = `
                    <div class="context-item" onclick="deleteFolderItems('${windowId}'); closeCtx()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        <span>删除选中 (${count})</span>
                    </div>
                `;
            } else {
                html = `
                    <div class="context-item" onclick="openFileFromPath('${fullPath}', '${filename}'); closeCtx()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                        <span>打开</span>
                    </div>
                    ${isArchiveFile(filename) ? `<div class="context-item" onclick="extractZipFromPath('${fullPath}'); closeCtx()"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 8v13H3V8"/></svg><span>解压</span></div>` : ''}
                    <div class="context-divider"></div>
                    <div class="context-item" onclick="renameFolderItem('${windowId}', '${filename}'); closeCtx()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                        <span>重命名</span>
                    </div>
                    <div class="context-item" onclick="deleteFolderItem('${windowId}', '${filename}'); closeCtx()" style="color:var(--win-close-red)">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/></svg>
                        <span>删除</span>
                    </div>
                `;
            }
            
            cm.innerHTML = html;
            showCtx(e.clientX, e.clientY);
        }

        function deleteFolderItems(windowId) {
            if(!confirm('确定删除选中项吗？')) return;
            
            const contentArea = document.getElementById('folder-content-' + windowId);
            if(!contentArea) return;
            
            const folderName = contentArea.closest('.window').querySelector('.window-title-text').innerText;
            const path = SYSTEM.desktopPath + '/' + folderName;
            
            const selectedItems = Array.from(contentArea.querySelectorAll('.folder-item.selected'));
            let deletedCount = 0;
            const total = selectedItems.length;
            
            selectedItems.forEach(item => {
                const filename = item.dataset.filename;
                const fullPath = path + '/' + filename;
                
                SYSTEM.fs.unlink(fullPath, (err) => {
                    if(err) {
                        console.error('删除失败:', filename, err);
                    } else {
                        deletedCount++;
                    }
                    
                    if(deletedCount === total) {
                        openFolderWindow(folderName);
                        Notify.success('删除成功', `已删除 ${total} 个文件`);
                    }
                });
            });
        }

        function deleteFolderItem(windowId, filename) {
            if(!confirm(`确定删除 "${filename}" 吗？`)) return;
            
            const contentArea = document.getElementById('folder-content-' + windowId);
            if(!contentArea) return;
            
            const folderName = contentArea.closest('.window').querySelector('.window-title-text').innerText;
            const path = SYSTEM.desktopPath + '/' + folderName;
            const fullPath = path + '/' + filename;
            
            SYSTEM.fs.unlink(fullPath, (err) => {
                if(err) {
                    Notify.error('删除失败', err.message);
                } else {
                    openFolderWindow(folderName);
                    Notify.success('删除成功', `文件 "${filename}" 已删除`);
                }
            });
        }

        function renameFolderItem(windowId, oldName) {
            const newName = prompt('请输入新名称:', oldName);
            if(!newName || newName === oldName) return;
            
            const contentArea = document.getElementById('folder-content-' + windowId);
            if(!contentArea) return;
            
            const folderName = contentArea.closest('.window').querySelector('.window-title-text').innerText;
            const path = SYSTEM.desktopPath + '/' + folderName;
            const oldPath = path + '/' + oldName;
            const newPath = path + '/' + newName;
            
            SYSTEM.fs.rename(oldPath, newPath, (err) => {
                if(err) {
                    Notify.error('重命名失败', err.message);
                } else {
                    openFolderWindow(folderName);
                    Notify.success('重命名成功', `已重命名为 "${newName}"`);
                }
            });
        }

        function setupFolderItemDrag(e, windowId) {
            const contentArea = document.getElementById('folder-content-' + windowId);
            if(!contentArea) return;
            
            const selectedItems = Array.from(contentArea.querySelectorAll('.folder-item.selected'));
            if(selectedItems.length === 0) return;
            
            const startX = e.clientX;
            const startY = e.clientY;
            let isDragging = false;
            let dragPreview = null;
            
            const onMouseMove = (moveEvent) => {
                const dx = moveEvent.clientX - startX;
                const dy = moveEvent.clientY - startY;
                
                if(!isDragging && (Math.abs(dx) > 5 || Math.abs(dy) > 5)) {
                    isDragging = true;
                    document.body.style.cursor = 'move';
                    
                    const folderName = contentArea.closest('.window').querySelector('.window-title-text').innerText;
                    const path = SYSTEM.desktopPath + '/' + folderName;
                    
                    const filesData = selectedItems.map(item => ({
                        filename: item.dataset.filename,
                        path: item.dataset.path
                    }));
                    
                    dragPreview = createDragPreview(filesData, moveEvent.clientX, moveEvent.clientY);
                }
                
                if(isDragging && dragPreview) {
                    dragPreview.style.left = (moveEvent.clientX + 10) + 'px';
                    dragPreview.style.top = (moveEvent.clientY + 10) + 'px';
                }
            };
            
            const onMouseUp = (upEvent) => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.body.style.cursor = '';
                
                if(dragPreview) {
                    dragPreview.remove();
                    dragPreview = null;
                }
                
                if(!isDragging) return;
                
                const target = upEvent.target;
                const desktop = document.getElementById('desktop');
                
                const folderName = contentArea.closest('.window').querySelector('.window-title-text').innerText;
                const sourcePath = SYSTEM.desktopPath + '/' + folderName;
                
                let targetPath = null;
                let targetFolderName = null;
                let operationType = 'copy';
                
                const folderWindow = target.closest('.window');
                const desktopIcon = target.closest('.desktop-icon');
                
                // === 修复后的判定逻辑 ===
                // 此处不再检查 desktop.contains(target)，因为 window 元素并不是 desktop 的子元素
                if (folderWindow) {
                    // 1. 如果目标是窗口（文件夹窗口）
                    const titleText = folderWindow.querySelector('.window-title-text').innerText;
                    // 在这个简易OS中，窗口标题即文件夹名
                    targetFolderName = titleText;
                    targetPath = SYSTEM.desktopPath + '/' + targetFolderName;
                    operationType = 'move';
                } else if (desktopIcon && desktopIcon.dataset.filename) {
                     // 2. 如果目标是桌面上的文件夹图标
                    const iconFilename = desktopIcon.dataset.filename;
                    // 这里简化逻辑：假设拖到桌面图标上就是往那个文件夹里放
                    targetPath = SYSTEM.desktopPath + '/' + iconFilename;
                    targetFolderName = iconFilename;
                    operationType = 'move';
                } else if (desktop.contains(target) || target === desktop || target.id === 'desktop-icons' || target.id === 'desktop-grid' || target.id === 'selection-box') {
                    // 3. 如果目标是桌面背景
                    targetPath = SYSTEM.desktopPath;
                    targetFolderName = '桌面';
                    operationType = 'move';
                } else {
                    // 无效目标
                    return;
                }
                
                if(!targetPath) return;
                
                if(targetPath === sourcePath) {
                    Notify.warning('操作无效', '不能将文件移动到同一文件夹');
                    return;
                }
                
                let processedCount = 0;
                let errorCount = 0;
                const total = selectedItems.length;
                const operationText = operationType === 'move' ? '移动' : '复制';
                
                const processFile = (item, callback) => {
                    const filename = item.dataset.filename;
                    const srcPath = item.dataset.path;
                    const destPath = targetPath + '/' + filename;
                    
                    console.log(`开始${operationText}文件: ${filename} 从 ${srcPath} 到 ${destPath}`);
                    
                    if(operationType === 'move') {
                        SYSTEM.fs.stat(destPath, (err) => {
                            if(!err) {
                                if(!confirm(`文件 "${filename}" 已存在于目标文件夹，是否覆盖？`)) {
                                    processedCount++;
                                    if(processedCount + errorCount === total) finishOperation();
                                    return;
                                }
                            }
                            
                            SYSTEM.fs.rename(srcPath, destPath, (renameErr) => {
                                if(renameErr) {
                                    errorCount++;
                                    console.error(`${operationText}文件失败:`, filename, renameErr);
                                } else {
                                    verifyFileIntegrity(destPath, filename, (isValid) => {
                                        if(isValid) {
                                            processedCount++;
                                            console.log(`${operationText}成功并验证通过:`, filename);
                                        } else {
                                            errorCount++;
                                            console.error(`${operationText}成功但验证失败:`, filename);
                                        }
                                        callback();
                                    });
                                }
                            });
                        });
                    } else {
                        SYSTEM.fs.readFile(srcPath, (readErr, data) => {
                            if(readErr) {
                                errorCount++;
                                console.error('读取文件失败:', filename, readErr);
                                callback();
                                return;
                            }
                            
                            SYSTEM.fs.writeFile(destPath, data, (writeErr) => {
                                if(writeErr) {
                                    errorCount++;
                                    console.error('写入文件失败:', filename, writeErr);
                                } else {
                                    verifyFileIntegrity(destPath, filename, (isValid) => {
                                        if(isValid) {
                                            processedCount++;
                                            console.log('复制成功并验证通过:', filename);
                                        } else {
                                            errorCount++;
                                            console.error('复制成功但验证失败:', filename);
                                        }
                                        callback();
                                    });
                                }
                            });
                        });
                    }
                };
                
                const verifyFileIntegrity = (filePath, filename, callback) => {
                    SYSTEM.fs.readFile(filePath, (err, data) => {
                        if(err) {
                            console.error('验证失败 - 无法读取文件:', filename, err);
                            callback(false);
                            return;
                        }
                        
                        const size = data.length;
                        const checksum = simpleChecksum(data);
                        
                        console.log(`文件验证: ${filename}, 大小: ${size} bytes, 校验和: ${checksum}`);
                        
                        callback(true);
                    });
                };
                
                const simpleChecksum = (buffer) => {
                    let hash = 0;
                    for(let i = 0; i < buffer.length; i++) {
                        const char = buffer[i];
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return hash.toString(16);
                };
                
                const finishOperation = () => {
                    refreshDesktop();
                    
                    if(operationType === 'move' && targetFolderName !== '桌面') {
                        setTimeout(() => openFolderWindow(targetFolderName), 300);
                    }
                    
                    if(errorCount > 0) {
                        Notify.error('部分失败', `成功${operationText} ${processedCount} 个文件，失败 ${errorCount} 个`);
                    } else {
                        Notify.success('操作成功', `已${operationText} ${total} 个文件到 ${targetFolderName}`);
                    }
                };
                
                let index = 0;
                const processNext = () => {
                    if(index >= total) {
                        finishOperation();
                        return;
                    }
                    
                    processFile(selectedItems[index], () => {
                        index++;
                        processNext();
                    });
                };
                
                processNext();
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function createDragPreview(filesData, x, y) {
            const preview = document.createElement('div');
            preview.className = 'drag-preview';
            preview.style.position = 'fixed';
            preview.style.left = (x + 10) + 'px';
            preview.style.top = (y + 10) + 'px';
            preview.style.zIndex = '10000';
            preview.style.opacity = '0.9';
            preview.style.pointerEvents = 'none';
            preview.style.background = 'rgba(24, 24, 32, 0.95)';
            preview.style.border = '1px solid rgba(0, 120, 212, 0.5)';
            preview.style.borderRadius = '8px';
            preview.style.padding = '12px 16px';
            preview.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.5)';
            preview.style.maxWidth = '200px';
            
            const count = filesData.length;
            const displayCount = count > 5 ? 5 : count;
            
            let html = `<div style="font-size: 12px; color: #8a8a9a; margin-bottom: 8px; font-weight: 500;">已选中 ${count} 个文件</div>`;
            html += '<div style="display: flex; flex-direction: column; gap: 6px;">';
            
            for(let i = 0; i < displayCount; i++) {
                const file = filesData[i];
                html += `<div style="font-size: 13px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.filename}</div>`;
            }
            
            if(count > 5) {
                html += `<div style="font-size: 12px; color: #8a8a9a;">...还有 ${count - 5} 个文件</div>`;
            }
            
            html += '</div>';
            preview.innerHTML = html;
            
            document.body.appendChild(preview);
            return preview;
        }

        function clearFolderSelection(windowId) {
            const contentArea = document.getElementById('folder-content-' + windowId);
            if(contentArea) {
                contentArea.querySelectorAll('.folder-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
            }
        }
        // === 修复：桌面背景右键菜单 & 新建文件夹 ===
        
        // 重新绑定桌面背景的右键事件
        document.getElementById('desktop').oncontextmenu = (e) => {
            // 如果点的是图标，不触发这个（由图标自己的逻辑触发）
            if(e.target.closest('.desktop-icon')) return;
            
            e.preventDefault();
            
            // 点击空白处时，清除已选中的图标
            clearSelection();
            
            const cm = document.getElementById('context-menu');
            cm.innerHTML = `
                <div class="context-item" onclick="document.getElementById('global-upload-file').click(); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <span>上传文件</span>
                </div>
                <div class="context-item" onclick="document.getElementById('global-upload-folder').click(); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2v11z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
                    <span>上传文件夹</span>
                </div>
                <div class="context-divider"></div>
                <div class="context-item" onclick="refreshDesktop(); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    <span>刷新桌面</span>
                </div>
                <div class="context-item" onclick="openWallpaperPanel(); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    <span>更换壁纸</span>
                </div>
                <div class="context-divider"></div>
                <div class="context-item" onclick="createNewFolder(); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2v11z"/></svg>
                    <span>新建文件夹</span>
                </div>
                <div class="context-item" onclick="openNotepad(); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    <span>新建文本文档</span>
                </div>
            `;
            showCtx(e.clientX, e.clientY);
        };

        // 补上新建文件夹功能的具体实现
        function createNewFolder() {
            const name = prompt("请输入文件夹名称:", "新建文件夹");
            if (!name) return;
            const path = SYSTEM.desktopPath + '/' + name;
            SYSTEM.fs.mkdir(path, (err) => {
                if (err) Notify.error("创建失败", err.message);
                else {
                    refreshDesktop();
                    Notify.success("成功", "文件夹创建成功");
                }
            });
        }

        // === 文件操作 ===
        function openFile(filename) {
            // 直接转接给通用打开函数，保证逻辑统一
            const fullPath = SYSTEM.desktopPath + '/' + filename;
            openFileFromPath(fullPath, filename);
        }

        // 通用的文件打开逻辑 (现在支持桌面文件和文件夹内的文件)
        function openFileFromPath(fullPath, filename) {
            // 1. 处理 HTML 文件 (自动跳转浏览器)
            if(filename.match(/\.html?$/i)) {
                SYSTEM.fs.readFile(fullPath, 'utf8', (err, data) => {
                    if(err) { Notify.error('打开失败', err.message); return; }
                    
                    // 将 HTML 内容转换为 Blob URL
                    const blob = new Blob([data], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    
                    // 直接调用浏览器打开
                    openBrowser(url);
                    Notify.success('正在打开', '已在浏览器中加载 HTML 文件');
                });
            }
            // 2. 处理图片文件 (改为调用漫画查看器)
            else if(filename.match(/\.(jpg|png|gif|webp|jpeg)$/i)) {
                openMangaViewer(fullPath, filename);
            } 
            // 3. 处理文本文件
            else if(filename.match(/\.txt$/i)) {
                SYSTEM.fs.readFile(fullPath, 'utf8', (err, data) => {
                    if(err) { Notify.error('打开失败', err.message); return; }
                    openNotepad(data, filename);
                });
            } 
            // 4. 处理压缩文件 (支持 zip/7z/rar/tar/gz 等格式)
            else if(isArchiveFile(filename)) {
                extractArchive(fullPath);
            } 
            // 5. 处理 PDF 文件
            else if(filename.match(/\.pdf$/i)) {
                SYSTEM.fs.readFile(fullPath, (err, data) => {
                    if(err) { Notify.error('打开失败', err.message); return; }
                    const base64 = SYSTEM.Buffer.from(data).toString('base64');
                    const dataUrl = `data:application/pdf;base64,${base64}`;
                    
                    createWindow({
                        title: filename,
                        iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><text x="8" y="18" font-size="4" fill="currentColor">PDF</text></svg>',
                        width: 800, height: 600,
                        content: `<div class="content-area dark" style="overflow:hidden">
                            <iframe src="${dataUrl}" style="width:100%;height:100%;border:none"></iframe>
                        </div>`
                    });
                });
            }
            // 6. 处理 MP4 视频文件
            else if(filename.match(/\.mp4$/i)) {
                SYSTEM.fs.readFile(fullPath, (err, data) => {
                    if(err) { Notify.error('打开失败', err.message); return; }
                    const base64 = SYSTEM.Buffer.from(data).toString('base64');
                    const dataUrl = `data:video/mp4;base64,${base64}`;
                    
                    createWindow({
                        title: filename,
                        iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>',
                        width: 800, height: 600,
                        content: `<div class="content-area dark" style="display:flex;align-items:center;justify-content:center;overflow:hidden">
                            <video src="${dataUrl}" controls autoplay style="max-width:100%;max-height:100%"></video>
                        </div>`
                    });
                });
            }
            else {
                Notify.warning('不支持的格式', '暂时无法打开此类型文件');
            }
        }

        function deleteFile(filename) {
            if(!confirm(`确定删除 "${filename}" 吗？`)) return;
            const path = SYSTEM.desktopPath + '/' + filename;
            
            SYSTEM.fs.stat(path, (err, stats) => {
                if(err) { Notify.error('删除失败', err.message); return; }
                
                if(stats.isDirectory()) {
                    deleteFolderRecursive(path, () => {
                        refreshDesktop();
                        Notify.success('删除成功', `文件夹 "${filename}" 已删除`);
                    });
                } else {
                    SYSTEM.fs.unlink(path, (err) => {
                        if(err) { Notify.error('删除失败', err.message); return; }
                        refreshDesktop();
                        Notify.success('删除成功', `文件 "${filename}" 已删除`);
                    });
                }
            });
        }

        function deleteFolderRecursive(path, callback) {
            SYSTEM.fs.readdir(path, (err, files) => {
                if(err) { callback(err); return; }
                
                let pending = files.length;
                if(!pending) {
                    SYSTEM.fs.rmdir(path, callback);
                    return;
                }
                
                files.forEach(file => {
                    const curPath = path + '/' + file;
                    SYSTEM.fs.stat(curPath, (err, stats) => {
                        if(stats.isDirectory()) {
                            deleteFolderRecursive(curPath, () => {
                                if(--pending === 0) SYSTEM.fs.rmdir(path, callback);
                            });
                        } else {
                            SYSTEM.fs.unlink(curPath, () => {
                                if(--pending === 0) SYSTEM.fs.rmdir(path, callback);
                            });
                        }
                    });
                });
            });
        }

        // ============================================
        // 统一解压函数 - 支持 zip/7z/rar/tar/gz 等格式
        // ============================================

        function isArchiveFile(filename) {
            return /\.(zip|7z|rar|tar|gz|bz2|xz|cab|tgz)$/i.test(filename);
        }

        function getArchiveType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            if (ext === 'zip') return 'zip';
            if (['7z', 'rar', 'tar', 'gz', 'bz2', 'xz', 'cab', 'tgz'].includes(ext)) return '7z';
            return 'unknown';
        }

        async function extractArchive(filePath) {
            const filename = filePath.split('/').pop();
            const folderName = filename.replace(/\.(zip|7z|rar|tar|gz|bz2|xz|cab|tgz)$/i, '');
            const parentDir = filePath.substring(0, filePath.lastIndexOf('/'));
            const targetDir = parentDir + '/' + folderName;
            const archiveType = getArchiveType(filename);

            const progressEl = document.createElement('div');
            progressEl.className = 'extract-progress';
            progressEl.innerHTML = `
                <h4>正在解压: ${filename}</h4>
                <div class="bar"><div class="bar-fill" id="extract-bar"></div></div>
                <p id="extract-status">读取压缩包...</p>
            `;
            document.body.appendChild(progressEl);

            const updateProgress = (percent) => {
                const bar = document.getElementById('extract-bar');
                if (bar) bar.style.width = percent + '%';
            };
            const updateStatus = (text) => {
                const status = document.getElementById('extract-status');
                if (status) status.innerText = text;
            };

            try {
                updateStatus('读取压缩包...');
                updateProgress(5);
                
                const fileData = await new Promise((resolve, reject) => {
                    SYSTEM.fs.readFile(filePath, (err, data) => {
                        if (err) reject(err);
                        else resolve(data);
                    });
                });

                await new Promise(resolve => {
                    SYSTEM.fs.mkdir(targetDir, () => resolve());
                });

                let extractedFiles = [];

                if (archiveType === 'zip') {
                    updateStatus('解析 ZIP 结构...');
                    updateProgress(10);
                    
                    const zip = await JSZip.loadAsync(fileData);
                    const files = Object.keys(zip.files).filter(name => !zip.files[name].dir);
                    const total = files.length;

                    for (let i = 0; i < files.length; i++) {
                        const relativePath = files[i];
                        const zipEntry = zip.files[relativePath];
                        
                        updateStatus(relativePath);
                        updateProgress(10 + (i / total) * 85);
                        
                        const content = await zipEntry.async('arraybuffer');
                        extractedFiles.push({
                            path: relativePath,
                            data: new Uint8Array(content)
                        });
                    }
                } else if (archiveType === '7z') {
                    if (!window.sevenZipReady) {
                        throw new Error('7z引擎未加载，请刷新页面重试');
                    }
                    
                    updateStatus('使用 7z 引擎解压...');
                    updateProgress(20);
                    
                    extractedFiles = await window.sevenZipEngine.extract(fileData, filename);
                    updateProgress(90);
                    
                    window.sevenZipEngine.cleanup();
                } else {
                    throw new Error('不支持的压缩格式');
                }

                updateStatus('写入文件...');
                const total = extractedFiles.length;
                
                for (let i = 0; i < extractedFiles.length; i++) {
                    const file = extractedFiles[i];
                    const fullPath = targetDir + '/' + file.path;
                    
                    const fileParentDir = fullPath.substring(0, fullPath.lastIndexOf('/'));
                    await ensureDir(fileParentDir);
                    
                    const buffer = SYSTEM.Buffer ? SYSTEM.Buffer.from(file.data) : file.data;
                    
                    await new Promise(resolve => {
                        SYSTEM.fs.writeFile(fullPath, buffer, () => resolve());
                    });
                    
                    updateProgress(90 + (i / total) * 10);
                }

                progressEl.remove();
                Notify.success('解压完成', `已解压 ${extractedFiles.length} 个文件到 "${folderName}"`);
                
                if (typeof refreshDesktop === 'function') refreshDesktop();
                if (typeof loadDirectory === 'function') loadDirectory(parentDir);
                if (typeof openFolderWindow === 'function') openFolderWindow(folderName);

            } catch (e) {
                progressEl.remove();
                Notify.error('解压失败', e.message);
                console.error('解压错误:', e);
            }
        }

        function extractZip(filename) {
            const path = SYSTEM.desktopPath + '/' + filename.split('/').pop();
            extractArchive(path);
        }

        function extractZipFromPath(filePath) {
            extractArchive(filePath);
        }

        async function ensureDir(path) {
            const parts = path.split('/').filter(p => p);
            let current = '';
            for(const part of parts) {
                current += '/' + part;
                await new Promise(resolve => {
                    SYSTEM.fs.mkdir(current, () => resolve());
                });
            }
        }

        // === 文件夹窗口 (V3 风格逻辑) ===


        // === 右键菜单 ===
        function closeCtx() {
            document.getElementById('context-menu').classList.remove('open');
        }



        function ctxApp(e, type) {
            e.preventDefault(); e.stopPropagation();
            const cm = document.getElementById('context-menu');
            const funcMap = {
                'browser': 'openBrowser',
                'notepad': 'openNotepad', 
                'calculator': 'openCalculator',
                'paint': 'openPaint',
                'settings': 'openSettings'
            };
            const funcName = funcMap[type] || ('open' + type.charAt(0).toUpperCase() + type.slice(1));
            cm.innerHTML = `
                <div class="context-item" onclick="${funcName}(); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    <span>打开</span>
                </div>
            `;
            showCtx(e.clientX, e.clientY);
        }

        function ctxFile(e, filename) {
            e.preventDefault(); e.stopPropagation();
            
            let menuItems = `
                <div class="context-item" onclick="openFile('${filename}'); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    <span>打开</span>
                </div>
            `;

            if (isArchiveFile(filename)) {
                menuItems += `
                    <div class="context-item" onclick="extractZip('${filename}'); closeCtx()">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 8v13H3V8"/><path d="M1 3h22v5H1z"/><path d="M10 12h4"/></svg>
                        <span>解压到当前文件夹</span>
                    </div>
                `;
            }

            menuItems += `
                <div class="context-item" onclick="renameFile('${filename}'); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                    <span>重命名</span>
                </div>
                <div class="context-divider"></div>
                <div class="context-item" onclick="deleteFile('${filename}'); closeCtx()">
                    <svg class="icon-svg" viewBox="0 0 24 24" style="color:var(--win-close-red)"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    <span style="color:var(--win-close-red)">删除</span>
                </div>
            `;

            document.getElementById('context-menu').innerHTML = menuItems;
            showCtx(e.clientX, e.clientY);
        }

        function showCtx(x, y) {
            const cm = document.getElementById('context-menu');
            cm.style.left = Math.min(x, window.innerWidth - 240) + 'px';
            cm.style.top = Math.min(y, window.innerHeight - 200) + 'px';
            cm.classList.add('open');
            SYSTEM.startOpen = false; document.getElementById('start-menu').classList.remove('open');
            SYSTEM.calendarOpen = false; document.getElementById('calendar-panel').classList.remove('open');
        }

        function renameFile(oldName) {
            const newName = prompt('请输入新名称:', oldName);
            if(!newName || newName === oldName) return;
            const oldPath = SYSTEM.desktopPath + '/' + oldName;
            const newPath = SYSTEM.desktopPath + '/' + newName;
            
            SYSTEM.fs.rename(oldPath, newPath, (err) => {
                if(err) Notify.error('重命名失败', err.message);
                else { refreshDesktop(); Notify.success('重命名成功', `已重命名为 "${newName}"`); }
            });
        }

        function renameDesktopFile(oldName) {
            const newName = prompt('请输入新名称:', oldName);
            if(!newName || newName === oldName) return;
            const oldPath = SYSTEM.desktopPath + '/' + oldName;
            const newPath = SYSTEM.desktopPath + '/' + newName;
            
            SYSTEM.fs.rename(oldPath, newPath, (err) => {
                if(err) Notify.error('重命名失败', err.message);
                else { 
                    refreshDesktop(); 
                    Notify.success('重命名成功', `已重命名为 "${newName}"`); 
                }
            });
        }

        document.addEventListener('click', e => {
            if(!e.target.closest('.context-menu')) closeCtx();
            if(!e.target.closest('.start-menu') && !e.target.closest('.start-btn')) {
                SYSTEM.startOpen = false; document.getElementById('start-menu').classList.remove('open');
            }
            if(!e.target.closest('.calendar-panel') && !e.target.closest('.clock')) {
                SYSTEM.calendarOpen = false; document.getElementById('calendar-panel').classList.remove('open');
            }
        });

        // === 开始菜单 ===
        function toggleStartMenu() {
            SYSTEM.startOpen = !SYSTEM.startOpen;
            document.getElementById('start-menu').classList.toggle('open', SYSTEM.startOpen);
            if(SYSTEM.startOpen) {
                SYSTEM.calendarOpen = false;
                document.getElementById('calendar-panel').classList.remove('open');
            }
        }

        // === 窗口系统 (完整适配版) ===
        function createWindow(opts) {
            const id = ++SYSTEM.idCounter;
            const isMobile = window.innerWidth <= 768; // 检测手机
            
            const w = document.createElement('div');
            w.id = 'win-' + id;
            
            // 如果是手机，自动添加 maximized 类
            w.className = `window ultra-glass focused ${isMobile ? 'maximized' : ''}`;
            
            // 只有电脑端才设置初始位置，手机端由CSS强制全屏
            if (!isMobile) {
                w.style.cssText = `width:${opts.width||700}px;height:${opts.height||500}px;top:${50+SYSTEM.windows.length*25}px;left:${100+SYSTEM.windows.length*25}px;`;
            }
            
            w.innerHTML = `
                <div class="title-bar">
                    <div class="title-bar-left">
                        <div class="window-icon">${opts.iconHtml || ''}</div>
                        <div class="window-title-text">${opts.title || 'Window'}</div>
                    </div>
                    <div class="window-controls">
                        <!-- 新增的全屏按钮，位于最小化之前 -->
                        <div class="win-btn" onclick="toggleWinFullscreen(${id}, '${opts.winType || 'default'}')">
                            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                        </div>
                        <div class="win-btn" onclick="minimizeWin(${id})"><svg class="icon-svg" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
                        <div class="win-btn" onclick="maximizeWin(${id})"><svg class="icon-svg" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></div>
                        <div class="win-btn close" onclick="closeWin(${id})"><svg class="icon-svg" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
                    </div>
                </div>
                ${opts.winType === 'manga' ? `<div class="manga-exit-btn" onclick="toggleWinFullscreen(${id}, 'manga')">×</div>` : ''}
                ${opts.content}
                <div class="resize-handle n"></div><div class="resize-handle s"></div>
                <div class="resize-handle e"></div><div class="resize-handle w"></div>
                <div class="resize-handle se"></div>
            `;
            
            document.getElementById('windows-container').appendChild(w);
            
            const winObj = { id, element: w, title: opts.title, minimized: false, maximized: isMobile };
            SYSTEM.windows.push(winObj);
            
            makeDraggable(w, id);
            makeResizable(w);
            focusWin(id);
            
            if(opts.onInit) opts.onInit(w, id);
            
            return id;
        }

        // 这里的函数必须定义在全局，否则 HTML onclick 找不到
        window.closeWin = function(id) {
            const w = document.getElementById('win-' + id);
            if(w) {
                w.style.transition = 'transform 0.2s, opacity 0.2s';
                w.style.transform = 'scale(0.9)';
                w.style.opacity = '0';
                setTimeout(() => w.remove(), 200);
            }
            SYSTEM.windows = SYSTEM.windows.filter(win => win.id !== id);
        };

        window.minimizeWin = function(id) {
            const win = SYSTEM.windows.find(w => w.id === id);
            if(win) {
                win.minimized = true;
                win.element.classList.add('minimized');
            }
        };

        window.maximizeWin = function(id) {
            const win = SYSTEM.windows.find(w => w.id === id);
            if(!win) return;
            // 手机端禁止取消最大化
            if (window.innerWidth <= 768) return;
            
            win.maximized = !win.maximized;
            win.element.classList.toggle('maximized', win.maximized);
            
            if(!win.maximized && win.savedPos) {
                win.element.style.cssText = win.savedPos;
            } else if(win.maximized) {
                win.savedPos = win.element.style.cssText;
            }
        };

        window.focusWin = function(id) {
            SYSTEM.windows.forEach(w => w.element.classList.remove('focused'));
            const win = SYSTEM.windows.find(w => w.id === id);
            if(win) {
                win.element.classList.add('focused');
                win.element.style.zIndex = ++SYSTEM.idCounter + 100;
                if(win.minimized) {
                    win.minimized = false;
                    win.element.classList.remove('minimized');
                }
            }
        };

        // === 修复后的拖拽逻辑 (完美支持手机/平板) ===
        function makeDraggable(el, id) {
            const titleBar = el.querySelector('.title-bar');
            let isDragging = false, startX, startY, startLeft, startTop;
            let dragPointerId = null;
            
            // 获取触摸或鼠标坐标
            const getCoords = (e) => {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            };

            const start = (e) => {
                // 如果点的是按钮，直接返回，不触发拖拽
                if(e.target.closest('.win-btn')) return;
                
                // 获取当前窗口对象
                const win = SYSTEM.windows.find(w => w.id === id);
                
                // 如果是手机模式(强制全屏) 或 窗口已最大化，则禁止拖动
                // 注意：这里阈值改为 600，与 CSS 保持一致，平板(>600)允许拖动
                if((win && win.maximized) || window.innerWidth <= 600) return;
                
                // 处理 Pointer Events
                if (e.pointerId !== undefined) {
                    if (dragPointerId === null) {
                        dragPointerId = e.pointerId;
                        e.target.setPointerCapture(e.pointerId);
                    } else {
                        return; // 已经有活动的拖拽指针
                    }
                }
                
                isDragging = true;
                const p = getCoords(e);
                startX = p.x; startY = p.y;
                startLeft = el.offsetLeft; startTop = el.offsetTop;
                
                focusWin(id);
            };
            
            const move = (e) => {
                if(!isDragging) return;
                
                // 验证指针ID
                if (e.pointerId !== undefined && e.pointerId !== dragPointerId) {
                    return;
                }
                
                // 只有在真正拖拽时，才阻止屏幕滚动
                if(e.cancelable) e.preventDefault();
                
                const p = getCoords(e);
                const dx = p.x - startX; 
                const dy = p.y - startY;
                
                el.style.left = startLeft + dx + 'px';
                el.style.top = Math.max(0, startTop + dy) + 'px';
            };
            
            const end = (e) => {
                if (!isDragging) return;
                
                // 验证指针ID
                if (e.pointerId !== undefined && e.pointerId !== dragPointerId) {
                    return;
                }
                
                isDragging = false;
                dragPointerId = null;
            };
            
            // 绑定事件 (仅绑定在标题栏上，不影响内容区域的点击)
            
            // 使用 Pointer Events API（统一处理鼠标和触摸）
            if (window.PointerEvent) {
                titleBar.addEventListener('pointerdown', start, { passive: false });
                titleBar.addEventListener('pointermove', move, { passive: false });
                titleBar.addEventListener('pointerup', end);
                titleBar.addEventListener('pointercancel', end);
                titleBar.addEventListener('pointerleave', end);
            } else {
                // 备用：鼠标事件
                titleBar.addEventListener('mousedown', start);
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', end);
                
                // 备用：触摸事件
                titleBar.addEventListener('touchstart', start, { passive: false });
                document.addEventListener('touchmove', move, { passive: false });
                document.addEventListener('touchend', end);
                document.addEventListener('touchcancel', end);
            }
            
            // 点击窗口任意位置聚焦（但不触发拖拽）
            el.addEventListener('mousedown', (e) => {
                // 如果点击的是画板区域，不要聚焦窗口（让画板处理事件）
                if (e.target.closest('.paint-app')) return;
                focusWin(id);
            });
            el.addEventListener('touchstart', (e) => {
                if (e.target.closest('.paint-app')) return;
                focusWin(id);
            }, { passive: true });
            el.addEventListener('pointerdown', (e) => {
                if (e.target.closest('.paint-app')) return;
                focusWin(id);
            }, { passive: true });
        }

        function makeResizable(el) {
            // 手机端禁用调整大小
            if(window.innerWidth <= 768) return;

            const handles = el.querySelectorAll('.resize-handle');
            handles.forEach(h => {
                let isResizing = false, startX, startY, startW, startH, startL, startT, dir;
                h.onmousedown = e => {
                    isResizing = true; startX = e.clientX; startY = e.clientY;
                    startW = el.offsetWidth; startH = el.offsetHeight;
                    startL = el.offsetLeft; startT = el.offsetTop;
                    dir = h.className.split(' ')[1];
                    e.preventDefault();
                };
                document.addEventListener('mousemove', e => {
                    if(!isResizing) return;
                    const dx = e.clientX - startX, dy = e.clientY - startY;
                    if(dir.includes('e')) el.style.width = Math.max(400, startW + dx) + 'px';
                    if(dir.includes('s')) el.style.height = Math.max(300, startH + dy) + 'px';
                    if(dir.includes('w')) { el.style.width = Math.max(400, startW - dx) + 'px'; el.style.left = startL + dx + 'px'; }
                    if(dir.includes('n')) { el.style.height = Math.max(300, startH - dy) + 'px'; el.style.top = startT + dy + 'px'; }
                });
                document.addEventListener('mouseup', () => { isResizing = false; });
            });
        }

        // === 应用程序 ===
        function openBrowser(initialUrl) {
            const startUrl = initialUrl || 'https://www.wikipedia.org';
            
            const id = createWindow({
                title: '浏览器',
                winType: 'browser',
                iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/></svg>',
                width: 900, height: 600,
                content: `
                    <div class="browser-nav">
                        <button class="nav-btn" id="nav-back-${SYSTEM.idCounter+1}"><svg class="icon-svg" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
                        <button class="nav-btn" id="nav-forward-${SYSTEM.idCounter+1}"><svg class="icon-svg" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></button>
                        <button class="nav-btn" id="nav-refresh-${SYSTEM.idCounter+1}"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></button>
                        <div class="address-bar">
                            <svg class="icon-svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                            <input type="text" id="url-input-${SYSTEM.idCounter+1}" placeholder="输入网址..." value="${startUrl}">
                        </div>
                        <button class="nav-btn" id="nav-go-${SYSTEM.idCounter+1}"><svg class="icon-svg" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
                    </div>
                    <div class="content-area" style="position:relative;">
                        <div class="loading-overlay" id="loading-${SYSTEM.idCounter+1}"><div class="spinner"></div><span>加载中...</span></div>
                        <iframe id="browser-frame-${SYSTEM.idCounter+1}" src="${startUrl}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
                    </div>
                `,
                onInit: (w, winId) => {
                    const urlInput = document.getElementById('url-input-' + winId);
                    const frame = document.getElementById('browser-frame-' + winId);
                    const loading = document.getElementById('loading-' + winId);
                    const goBtn = document.getElementById('nav-go-' + winId);
                    const refreshBtn = document.getElementById('nav-refresh-' + winId);
                    const backBtn = document.getElementById('nav-back-' + winId);
                    const fwdBtn = document.getElementById('nav-forward-' + winId);
                    
                    // 历史栈数据
                    let historyStack = [startUrl];
                    let currentIndex = 0;
                    
                    // 修复：UI更新不再设置 disabled 属性，而是仅改变透明度视觉效果
                    const updateUI = () => {
                        // 如果没有后退历史，降低透明度，但不禁用点击
                        backBtn.style.opacity = currentIndex === 0 ? '0.3' : '1';
                        backBtn.style.cursor = currentIndex === 0 ? 'default' : 'pointer'; // 没历史时显示普通鼠标，有历史显示手型
                        
                        // 如果没有前进历史，降低透明度
                        fwdBtn.style.opacity = currentIndex === historyStack.length - 1 ? '0.3' : '1';
                        fwdBtn.style.cursor = currentIndex === historyStack.length - 1 ? 'default' : 'pointer';
                        
                        urlInput.value = historyStack[currentIndex];
                    };

                    const loadFrame = (url) => {
                        loading.classList.add('active');
                        frame.src = url;
                    };

                    const navigate = () => {
                        let url = urlInput.value.trim();
                        if(!url.startsWith('http') && !url.startsWith('blob:') && !url.startsWith('file:')) {
                            url = 'https://' + url;
                        }
                        
                        if (url !== historyStack[currentIndex]) {
                            historyStack = historyStack.slice(0, currentIndex + 1);
                            historyStack.push(url);
                            currentIndex++;
                        }
                        
                        updateUI();
                        loadFrame(url);
                    };
                    
                    urlInput.onkeydown = e => { if(e.key === 'Enter') navigate(); };
                    goBtn.onclick = navigate;
                    
                    refreshBtn.onclick = () => { 
                        loading.classList.add('active'); 
                        // 强制刷新 iframe
                        const currentUrl = frame.src;
                        frame.src = 'about:blank';
                        setTimeout(() => { frame.src = currentUrl; }, 10);
                    };
                    
                    frame.onload = () => loading.classList.remove('active');

                    // 后退逻辑：点击不再被阻挡，内部判断是否有动作
                    backBtn.onclick = () => { 
                        if (currentIndex > 0) {
                            currentIndex--;
                            const prevUrl = historyStack[currentIndex];
                            loadFrame(prevUrl);
                            updateUI();
                        }
                    };

                    // 前进逻辑
                    fwdBtn.onclick = () => { 
                        if (currentIndex < historyStack.length - 1) {
                            currentIndex++;
                            const nextUrl = historyStack[currentIndex];
                            loadFrame(nextUrl);
                            updateUI();
                        }
                    };
                    
                    updateUI();
                }
            });
        }

        function openNotepad(content = '', filename = '未命名.txt') {
            const id = createWindow({
                title: '记事本 - ' + filename,
                iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>',
                width: 650, height: 480,
                content: `
                    <div class="notepad-toolbar">
                        <button class="notepad-btn" id="np-new-${SYSTEM.idCounter+1}">新建</button>
                        <button class="notepad-btn" id="np-save-${SYSTEM.idCounter+1}">保存</button>
                        <button class="notepad-btn" id="np-saveas-${SYSTEM.idCounter+1}">另存为</button>
                    </div>
                    <textarea class="notepad-area" id="np-area-${SYSTEM.idCounter+1}" placeholder="开始输入...">${content}</textarea>
                `,
                onInit: (w, winId) => {
                    let currentFile = filename;
                    const area = document.getElementById('np-area-' + winId);
                    
                    document.getElementById('np-new-' + winId).onclick = () => {
                        area.value = '';
                        currentFile = '未命名.txt';
                        w.querySelector('.window-title-text').innerText = '记事本 - ' + currentFile;
                    };
                    
                    document.getElementById('np-save-' + winId).onclick = () => {
                        const path = SYSTEM.desktopPath + '/' + currentFile;
                        SYSTEM.fs.writeFile(path, area.value, 'utf8', err => {
                            if(err) Notify.error('保存失败', err.message);
                            else { refreshDesktop(); Notify.success('保存成功', `文件已保存为 "${currentFile}"`); }
                        });
                    };
                    
                    document.getElementById('np-saveas-' + winId).onclick = () => {
                        const name = prompt('请输入文件名:', currentFile);
                        if(!name) return;
                        currentFile = name.endsWith('.txt') ? name : name + '.txt';
                        const path = SYSTEM.desktopPath + '/' + currentFile;
                        SYSTEM.fs.writeFile(path, area.value, 'utf8', err => {
                            if(err) Notify.error('保存失败', err.message);
                            else {
                                w.querySelector('.window-title-text').innerText = '记事本 - ' + currentFile;
                                refreshDesktop();
                                Notify.success('保存成功', `文件已保存为 "${currentFile}"`);
                            }
                        });
                    };
                }
            });
        }

        function openCalculator() {
            const id = createWindow({
                title: '计算器',
                iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/></svg>',
                width: 320, height: 450,
                content: `
                    <div class="calculator" style="background:#1a1a24">
                        <div class="calc-display">
                            <div class="expression" id="calc-expr-${SYSTEM.idCounter+1}"></div>
                            <div class="result" id="calc-result-${SYSTEM.idCounter+1}">0</div>
                        </div>
                        <div class="calc-buttons" id="calc-btns-${SYSTEM.idCounter+1}"></div>
                    </div>
                `,
                onInit: (w, winId) => {
                    const btnsContainer = document.getElementById('calc-btns-' + winId);
                    const expr = document.getElementById('calc-expr-' + winId);
                    const result = document.getElementById('calc-result-' + winId);
                    
                    const buttons = ['C','±','%','÷','7','8','9','×','4','5','6','-','1','2','3','+','0','.','⌫','='];
                    
                    let current = '0', expression = '', lastOp = '';
                    
                    buttons.forEach(b => {
                        const btn = document.createElement('button');
                        btn.className = 'calc-btn';
                        btn.innerText = b;
                        
                        if(['÷','×','-','+'].includes(b)) btn.classList.add('operator');
                        if(b === '=') btn.classList.add('equals');
                        if(b === 'C') btn.classList.add('clear');
                        
                        btn.onclick = () => {
                            if(b >= '0' && b <= '9') {
                                current = current === '0' ? b : current + b;
                            } else if(b === '.') {
                                if(!current.includes('.')) current += '.';
                            } else if(b === 'C') {
                                current = '0'; expression = '';
                            } else if(b === '⌫') {
                                current = current.length > 1 ? current.slice(0,-1) : '0';
                            } else if(b === '±') {
                                current = current.startsWith('-') ? current.slice(1) : '-' + current;
                            } else if(b === '%') {
                                current = String(parseFloat(current) / 100);
                            } else if(['÷','×','-','+'].includes(b)) {
                                expression += current + ' ' + b + ' ';
                                current = '0';
                            } else if(b === '=') {
                                expression += current;
                                try {
                                    let evalExpr = expression.replace(/×/g,'*').replace(/÷/g,'/');
                                    current = String(eval(evalExpr));
                                    if(current === 'Infinity' || current === 'NaN') current = 'Error';
                                } catch { current = 'Error'; }
                                expression = '';
                            }
                            
                            result.innerText = current;
                            expr.innerText = expression;
                        };
                        
                        btnsContainer.appendChild(btn);
                    });
                }
            });
        }

        function openPaint() {
            const id = createWindow({
                title: '画板',
                iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/></svg>',
                width: 800, height: 550,
                content: `
                    <div class="paint-app">
                        <div class="paint-toolbar">
                            <div class="paint-tool-group">
                                <button class="paint-btn active" id="paint-brush-${SYSTEM.idCounter+1}" title="画笔">
                                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
                                </button>
                                <button class="paint-btn" id="paint-eraser-${SYSTEM.idCounter+1}" title="橡皮擦">
                                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>
                                </button>
                            </div>
                            <div class="paint-tool-group">
                                <label>颜色</label>
                                <input type="color" class="color-picker" id="paint-color-${SYSTEM.idCounter+1}" value="#000000">
                            </div>
                            <div class="paint-tool-group">
                                <label>大小</label>
                                <input type="range" class="brush-size" id="paint-size-${SYSTEM.idCounter+1}" min="1" max="50" value="5">
                            </div>
                            <div class="paint-tool-group">
                                <button class="paint-btn" id="paint-clear-${SYSTEM.idCounter+1}" title="清空">
                                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                                <button class="paint-btn" id="paint-save-${SYSTEM.idCounter+1}" title="保存">
                                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="paint-canvas-container" id="paint-container-${SYSTEM.idCounter+1}" style="background:#ffffff; overflow:hidden;">
                            <canvas class="paint-canvas" id="paint-canvas-${SYSTEM.idCounter+1}"></canvas>
                        </div>
                    </div>
                `,
                onInit: (w, winId) => {
                    const container = document.getElementById('paint-container-' + winId);
                    const canvas = document.getElementById('paint-canvas-' + winId);
                    const ctx = canvas.getContext('2d', { alpha: false });

                    // 虚拟画布 - 存储完整图像
                    const vCanvas = document.createElement('canvas');
                    const vCtx = vCanvas.getContext('2d', { alpha: false });
                    
                    // 设置缓冲区大小
                    const bufferW = Math.max(window.screen.width, 1920);
                    const bufferH = Math.max(window.screen.height, 1080);
                    vCanvas.width = bufferW;
                    vCanvas.height = bufferH;
                    
                    // 初始化白色背景
                    vCtx.fillStyle = '#ffffff';
                    vCtx.fillRect(0, 0, bufferW, bufferH);

                    // 同步画布尺寸并绘制
                    const syncCanvas = () => {
                        canvas.width = container.clientWidth;
                        canvas.height = container.clientHeight;
                        ctx.drawImage(vCanvas, 0, 0);
                    };

                    // 监听容器尺寸变化
                    const ro = new ResizeObserver(() => syncCanvas());
                    ro.observe(container);

                    // 绘制状态
                    let isDrawing = false;
                    let lastX = 0, lastY = 0;
                    let tool = 'brush';
                    let activePointerId = null;
                    
                    const colorPicker = document.getElementById('paint-color-' + winId);
                    const sizePicker = document.getElementById('paint-size-' + winId);

                    // 绘制函数
                    const draw = (x1, y1, x2, y2) => {
                        const color = tool === 'eraser' ? '#ffffff' : colorPicker.value;
                        const size = parseInt(sizePicker.value) || 5;

                        [ctx, vCtx].forEach(c => {
                            c.beginPath();
                            c.strokeStyle = color;
                            c.lineWidth = size;
                            c.lineCap = 'round';
                            c.lineJoin = 'round';
                            c.moveTo(x1, y1);
                            c.lineTo(x2, y2);
                            c.stroke();
                        });
                    };

                    // 获取坐标（支持鼠标和触摸）
                    const getCoords = (e) => {
                        const rect = canvas.getBoundingClientRect();
                        let clientX, clientY;
                        
                        if (e.touches && e.touches.length > 0) {
                            clientX = e.touches[0].clientX;
                            clientY = e.touches[0].clientY;
                        } else if (e.changedTouches && e.changedTouches.length > 0) {
                            clientX = e.changedTouches[0].clientX;
                            clientY = e.changedTouches[0].clientY;
                        } else {
                            clientX = e.clientX;
                            clientY = e.clientY;
                        }
                        
                        return {
                            x: clientX - rect.left,
                            y: clientY - rect.top
                        };
                    };

                    // 开始绘制
                    const startDrawing = (e) => {
                        // 防止默认行为（滚动、缩放等）
                        if (e.cancelable) e.preventDefault();
                        
                        // 处理多点触控 - 只响应第一个触点
                        if (e.pointerId !== undefined) {
                            if (activePointerId === null) {
                                activePointerId = e.pointerId;
                            } else if (activePointerId !== e.pointerId) {
                                return; // 忽略其他触点
                            }
                        }
                        
                        isDrawing = true;
                        const coords = getCoords(e);
                        lastX = coords.x;
                        lastY = coords.y;
                    };

                    // 绘制中
                    const drawMove = (e) => {
                        if (!isDrawing) return;
                        
                        // 防止默认行为
                        if (e.cancelable) e.preventDefault();
                        
                        // 验证指针ID
                        if (e.pointerId !== undefined && e.pointerId !== activePointerId) {
                            return;
                        }
                        
                        const coords = getCoords(e);
                        const curX = coords.x;
                        const curY = coords.y;
                        
                        draw(lastX, lastY, curX, curY);
                        
                        lastX = curX;
                        lastY = curY;
                    };

                    // 结束绘制
                    const endDrawing = (e) => {
                        if (!isDrawing) return;
                        
                        // 验证指针ID
                        if (e.pointerId !== undefined && e.pointerId !== activePointerId) {
                            return;
                        }
                        
                        isDrawing = false;
                        activePointerId = null;
                    };

                    // 使用 Pointer Events API（统一处理鼠标和触摸）
                    canvas.addEventListener('pointerdown', startDrawing, { passive: false });
                    canvas.addEventListener('pointermove', drawMove, { passive: false });
                    canvas.addEventListener('pointerup', endDrawing);
                    canvas.addEventListener('pointercancel', endDrawing);
                    canvas.addEventListener('pointerleave', endDrawing);

                    // 备用：鼠标事件（兼容旧浏览器）
                    canvas.addEventListener('mousedown', (e) => {
                        if (!window.PointerEvent) startDrawing(e);
                    });
                    canvas.addEventListener('mousemove', (e) => {
                        if (!window.PointerEvent) drawMove(e);
                    });
                    canvas.addEventListener('mouseup', (e) => {
                        if (!window.PointerEvent) endDrawing(e);
                    });
                    canvas.addEventListener('mouseleave', (e) => {
                        if (!window.PointerEvent) endDrawing(e);
                    });

                    // 备用：触摸事件（兼容旧浏览器）
                    canvas.addEventListener('touchstart', (e) => {
                        if (!window.PointerEvent) startDrawing(e);
                    }, { passive: false });
                    canvas.addEventListener('touchmove', (e) => {
                        if (!window.PointerEvent) drawMove(e);
                    }, { passive: false });
                    canvas.addEventListener('touchend', (e) => {
                        if (!window.PointerEvent) endDrawing(e);
                    });
                    canvas.addEventListener('touchcancel', (e) => {
                        if (!window.PointerEvent) endDrawing(e);
                    });

                    // 工具按钮事件
                    const brushBtn = document.getElementById('paint-brush-' + winId);
                    const eraserBtn = document.getElementById('paint-eraser-' + winId);
                    
                    brushBtn.onclick = function() {
                        tool = 'brush';
                        this.classList.add('active');
                        eraserBtn.classList.remove('active');
                    };
                    
                    eraserBtn.onclick = function() {
                        tool = 'eraser';
                        this.classList.add('active');
                        brushBtn.classList.remove('active');
                    };
                    
                    // 清空画布
                    document.getElementById('paint-clear-' + winId).onclick = () => {
                        if(!confirm("确定清空画布吗？")) return;
                        vCtx.fillStyle = '#ffffff';
                        vCtx.fillRect(0, 0, vCanvas.width, vCanvas.height);
                        syncCanvas();
                    };
                    
                    // 保存图片
                    document.getElementById('paint-save-' + winId).onclick = () => {
                        const name = prompt('请输入文件名:', '画作.png');
                        if(!name) return;
                        
                        const saveCanvas = document.createElement('canvas');
                        saveCanvas.width = canvas.width;
                        saveCanvas.height = canvas.height;
                        saveCanvas.getContext('2d').drawImage(vCanvas, 0, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
                        
                        saveCanvas.toBlob(blob => {
                            const reader = new FileReader();
                            reader.onload = () => {
                                const buffer = SYSTEM.Buffer.from(reader.result);
                                const path = SYSTEM.desktopPath + '/' + (name.endsWith('.png') ? name : name + '.png');
                                SYSTEM.fs.writeFile(path, buffer, err => {
                                    if(err) Notify.error('保存失败', err.message);
                                    else { refreshDesktop(); Notify.success('保存成功', '已保存当前可见区域'); }
                                });
                            };
                            reader.readAsArrayBuffer(blob);
                        }, 'image/png');
                    };

                    // 初始同步
                    syncCanvas();

                    // 清理
                    const originalClose = window.closeWin;
                    window.closeWin = function(closeId) {
                        if(closeId === winId) {
                            ro.disconnect();
                            canvas.removeEventListener('pointerdown', startDrawing);
                            canvas.removeEventListener('pointermove', drawMove);
                            canvas.removeEventListener('pointerup', endDrawing);
                            canvas.removeEventListener('pointercancel', endDrawing);
                            canvas.removeEventListener('pointerleave', endDrawing);
                        }
                        originalClose(closeId);
                    };
                }
            });
        }

        // 漫画/长图查看器：打开单张图片时触发，加载同目录下所有图片
        function openMangaViewer(targetFullPath, targetFilename) {
            // 获取当前图片所在的目录路径
            const folderPath = targetFullPath.substring(0, targetFullPath.lastIndexOf('/'));

            SYSTEM.fs.readdir(folderPath, (err, files) => {
                if (err) { Notify.error('加载失败', err.message); return; }

                // 1. 过滤同目录下的所有图片
                // 2. 进行自然数字排序 (1.jpg, 2.jpg, 10.jpg)
                const imageFiles = files.filter(f => f.match(/\.(jpg|jpeg|png|webp|gif)$/i))
                                        .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

                const winId = createWindow({
                    title: '漫画阅读器 - ' + targetFilename,
                    winType: 'manga',
                    iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M21 15l-3-3L6 21"/></svg>',
                    width: 800, height: 600,
                    content: `
                        <div class="content-area dark" style="position:relative; height:100%; overflow:hidden;">
                            <div id="manga-viewer-${SYSTEM.idCounter+1}" style="overflow-y:auto; background:#000; height:100%; display:flex; flex-direction:column; align-items:center;">
                                <div id="manga-loading-${SYSTEM.idCounter+1}" style="padding:40px; color:#666;">正在加载漫画序列...</div>
                            </div>
                        </div>
                    `,
                    onInit: (w, id) => {
                        const viewer = document.getElementById(`manga-viewer-${id}`);
                        const loading = document.getElementById(`manga-loading-${id}`);
                        
                        // 异步按顺序加载图片
                        let loadedCount = 0;
                        imageFiles.forEach((filename, index) => {
                            const fullPath = folderPath + '/' + filename;
                            SYSTEM.fs.readFile(fullPath, (err, data) => {
                                if (err) return;
                                
                                const blob = new Blob([data]);
                                const url = URL.createObjectURL(blob);
                                
                                const img = document.createElement('img');
                                img.src = url;
                                img.id = `manga-img-${id}-${index}`;
                                img.style.width = '100%';
                                img.style.maxWidth = '1000px'; // 限制最大宽度
                                img.style.display = 'block';
                                img.style.pointerEvents = 'none'; // 防止干扰窗口操作
                                
                                // 按照排序索引插入，确保顺序正确
                                viewer.appendChild(img);
                                
                                loadedCount++;
                                if(loadedCount === 1) loading.remove(); // 加载出第一张就移除文字
                                
                                // 如果是用户点击的那张图片，滚动到该位置
                                if (filename === targetFilename) {
                                    setTimeout(() => img.scrollIntoView(), 100);
                                }
                            });
                        });
                    }
                });
            });
        }

        // === V86 虚拟机应用 ===
        function openV86() {
            const winId = createWindow({
                title: 'V86 虚拟机',
                winType: 'v86',
                iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
                width: 800, height: 600,
                content: `
                    <div class="v86-app">
                        <div class="v86-toolbar">
                            <input type="file" id="v86-file-${SYSTEM.idCounter+1}" accept=".img,.iso,.bin" style="display:none">
                            <button class="notepad-btn" onclick="document.getElementById('v86-file-${SYSTEM.idCounter+1}').click()">
                                <svg class="icon-svg sm" viewBox="0 0 24 24" style="display:inline;vertical-align:middle;margin-right:4px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                加载镜像
                            </button>
                            <button class="notepad-btn" id="v86-reset-${SYSTEM.idCounter+1}">
                                <svg class="icon-svg sm" viewBox="0 0 24 24" style="display:inline;vertical-align:middle;margin-right:4px"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                重置
                            </button>
                            <button class="notepad-btn" id="v86-pause-${SYSTEM.idCounter+1}">
                                暂停
                            </button>
                            <span style="color:var(--text-muted);font-size:12px;margin-left:auto" id="v86-status-${SYSTEM.idCounter+1}">就绪</span>
                        </div>
                        <div class="v86-screen-container" id="v86-screen-${SYSTEM.idCounter+1}">
                            <div style="white-space: pre; font: 14px monospace; line-height: 14px; display: none;"></div>
                            <canvas style="display:none"></canvas>
                            <div id="v86-placeholder-${SYSTEM.idCounter+1}" style="color:#666;text-align:center;padding:40px">
                                <svg class="icon-svg xl" viewBox="0 0 24 24" style="color:#444;margin-bottom:16px"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                                <p>点击"加载镜像"选择 .img 或 .iso 文件启动虚拟机</p>
                                <p style="font-size:12px;color:#555;margin-top:8px">支持: 软盘镜像、CD-ROM 镜像</p>
                            </div>
                        </div>
                    </div>
                `,
                onInit: (w, id) => {
                    let emulator = null;
                    const screenContainer = document.getElementById(`v86-screen-${id}`);
                    const placeholder = document.getElementById(`v86-placeholder-${id}`);
                    const statusText = document.getElementById(`v86-status-${id}`);
                    const fileInput = document.getElementById(`v86-file-${id}`);
                    const resetBtn = document.getElementById(`v86-reset-${id}`);
                    const pauseBtn = document.getElementById(`v86-pause-${id}`);
                    const updateStatus = (msg, showNotify = false) => {
                        statusText.innerText = msg;
                        if (showNotify) {
                            Notify.info('V86', msg);
                        }
                    };

                    // 鼠标锁定功能
                    const lockMouse = async () => {
                        if (!emulator) return;
                        try {
                            await screenContainer.requestPointerLock();
                        } catch (err) {
                            console.log('鼠标锁定失败:', err);
                        }
                    };

                    const unlockMouse = () => {
                        if (document.pointerLockElement === screenContainer) {
                            document.exitPointerLock();
                        }
                    };

                    // 监听指针锁定变化
                    const onPointerLockChange = () => {
                        if (document.pointerLockElement === screenContainer) {
                            screenContainer.classList.add('locked');
                        } else {
                            screenContainer.classList.remove('locked');
                        }
                    };

                    document.addEventListener('pointerlockchange', onPointerLockChange);

                    // 点击屏幕锁定鼠标
                    screenContainer.addEventListener('click', (e) => {
                        if (emulator && document.pointerLockElement !== screenContainer) {
                            lockMouse();
                        }
                    });

                    // 清理函数
                    w.onDestroy = () => {
                        unlockMouse();
                        document.removeEventListener('pointerlockchange', onPointerLockChange);
                    };

                    const initV86 = (fileName, buffer) => {
                        placeholder.style.display = 'none';
                        
                        // 清除之前的 canvas
                        const oldCanvas = screenContainer.querySelector('canvas');
                        if (oldCanvas) oldCanvas.remove();
                        
                        // 创建新的 canvas
                        const canvas = document.createElement('canvas');
                        canvas.style.display = 'block';
                        screenContainer.appendChild(canvas);

                        const V86Constructor = window.V86Starter || window.V86;
                        if (!V86Constructor) {
                            updateStatus('V86 库未加载', true);
                            return;
                        }

                        const settings = {
                            wasm_path: "https://cdn.jsdelivr.net/npm/v86@latest/build/v86.wasm",
                            bios: { url: "https://cdn.jsdelivr.net/npm/v86@latest/bios/seabios.bin" },
                            vga_bios: { url: "https://cdn.jsdelivr.net/npm/v86@latest/bios/vgabios.bin" },
                            screen_container: screenContainer,
                            memory_size: 64 * 1024 * 1024,
                            vga_memory_size: 8 * 1024 * 1024,
                            autostart: true
                        };

                        if (fileName.toLowerCase().endsWith('.iso')) {
                            settings.cdrom = { buffer: buffer };
                            updateStatus('正在从 CD-ROM 启动...');
                        } else {
                            settings.fda = { buffer: buffer };
                            updateStatus('正在从软盘启动...');
                        }

                        try {
                            emulator = new V86Constructor(settings);
                            updateStatus('虚拟机运行中: ' + fileName, true);

                            emulator.add_listener("serial0-output-char", function(char) {
                                // 串口输出到控制台
                                if (char === '\n') console.log('[V86 Serial]');
                                else process.stdout?.write?.(char);
                            });

                        } catch (err) {
                            console.error(err);
                            updateStatus('启动失败: ' + err.message, true);
                            placeholder.style.display = 'block';
                        }
                    };

                    fileInput.onchange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        updateStatus('正在读取文件...');
                        
                        reader.onload = (ev) => {
                            initV86(file.name, ev.target.result);
                        };
                        reader.readAsArrayBuffer(file);
                    };

                    resetBtn.onclick = () => {
                        if (emulator) {
                            emulator.restart();
                            updateStatus('虚拟机已重置', true);
                        } else {
                            updateStatus('请先加载镜像', true);
                        }
                    };

                    pauseBtn.onclick = () => {
                        if (!emulator) {
                            updateStatus('请先加载镜像', true);
                            return;
                        }
                        if (pauseBtn.innerText === '暂停') {
                            emulator.stop();
                            pauseBtn.innerText = '继续';
                            updateStatus('虚拟机已暂停', true);
                        } else {
                            emulator.run();
                            pauseBtn.innerText = '暂停';
                            updateStatus('虚拟机继续运行', true);
                        }
                    };
                }
            });
        }

        function openSettings() {
            createWindow({
                title: '系统设置',
                iconHtml: '<svg class="icon-svg sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/></svg>',
                width: 550, height: 500,
                content: `
                    <div class="content-area dark" style="overflow-y:auto">
                        <div class="settings-content">
                            <div class="about-card">
                                <div class="logo">JISHENG OS</div>
                                <p>Ultimate Web Operating System<br>Version 10.1 • Build 2026</p>
                            </div>
                            
                            <div class="settings-section" style="margin-top:20px">
                                <h4>个性化</h4>
                                <div class="settings-item" onclick="openWallpaperPanel()" style="cursor:pointer">
                                    <label>更换壁纸</label>
                                    <svg class="icon-svg" viewBox="0 0 24 24" style="color:var(--text-muted)"><polyline points="9 18 15 12 9 6"/></svg>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <h4>存储</h4>
                                <div class="settings-item">
                                    <label>虚拟磁盘</label>
                                    <span>IndexedDB</span>
                                </div>
                                <div class="settings-item" onclick="resetSystem()" style="cursor:pointer">
                                    <label style="color:var(--win-close-red)">重置系统</label>
                                    <svg class="icon-svg" viewBox="0 0 24 24" style="color:var(--win-close-red)"><polyline points="9 18 15 12 9 6"/></svg>
                                </div>
                            </div>
                            
                            <div class="settings-section">
                                <h4>关于</h4>
                                <div class="settings-item">
                                    <label>系统版本</label>
                                    <span>10.1.0</span>
                                </div>
                                <div class="settings-item">
                                    <label>内核</label>
                                    <span>BrowserFS</span>
                                </div>
                                <div class="settings-item">
                                    <label>渲染引擎</label>
                                    <span>${navigator.userAgent.match(/Chrome|Firefox|Safari|Edge/)?.[0] || 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            });
        }

        // === 壁纸管理 ===
        function openWallpaperPanel() {
            document.getElementById('wallpaper-panel').classList.add('open');
            document.getElementById('overlay').classList.add('active');
            document.getElementById('wp-grid').innerHTML = wallpapers.map(u => 
                `<div class="wp-thumb" style="background-image:url('${u}')" onclick="setBg('${u}')"></div>`
            ).join('');
            closeCtx();
        }
        
        function closePanel() {
            document.getElementById('wallpaper-panel').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }
        
        function setBg(u, save = true) {
            document.getElementById('dynamic-bg').style.backgroundImage = `url('${u}')`;
            if (save && SYSTEM.mounted) {
                SYSTEM.fs.writeFile(SYSTEM.configPath, u, (err) => { if(err) console.error("Save WP failed", err); });
            }
        }
        
        const fileInput = document.getElementById('file-input');
        fileInput.onchange = e => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = ev => setBg(ev.target.result);
                r.readAsDataURL(f);
            }
        };



        function resetSystem() {
            if(confirm("警告：这会清空所有保存的文件和设置。确定重置吗？")) {
                const req = indexedDB.deleteDatabase('JISHENG_OS_V3');
                req.onsuccess = () => location.reload();
            }
        }

        // 启动
        window.onload = initKernel;
    </script>

    <!-- ========== 7z-wasm 解压引擎（放在 </body> 前面）========== -->
    <script type="module">
    import SevenZip from 'https://cdn.jsdelivr.net/npm/7z-wasm@1.2.0/7zz.es6.min.js';

    class SevenZipEngine {
        constructor() {
            this.sevenZip = null;
            this.ready = false;
        }

        async init() {
            try {
                this.sevenZip = await SevenZip({
                    print: (t) => console.log('[7z]', t),
                    printErr: (t) => console.error('[7z]', t)
                });
                this.ready = true;
                console.log('✅ 7z-wasm 引擎加载成功');
                return true;
            } catch (e) {
                console.error('❌ 7z-wasm 加载失败:', e);
                return false;
            }
        }

        async extract(arrayBuffer, filename) {
            if (!this.ready) throw new Error('7z引擎未加载');
            
            const data = new Uint8Array(arrayBuffer);
            
            const stream = this.sevenZip.FS.open(filename, 'w+');
            this.sevenZip.FS.write(stream, data, 0, data.length);
            this.sevenZip.FS.close(stream);
            
            this.sevenZip.callMain(['x', '-y', filename]);
            
            try { this.sevenZip.FS.unlink(filename); } catch(e) {}
            
            return this.collectFiles('/');
        }

        collectFiles(path = '/') {
            const files = [];
            const skip = ['tmp', 'home', 'dev', 'proc'];
            try {
                const entries = this.sevenZip.FS.readdir(path);
                for (const entry of entries) {
                    if (entry === '.' || entry === '..' || skip.includes(entry)) continue;
                    const fullPath = path === '/' ? '/' + entry : path + '/' + entry;
                    try {
                        const stat = this.sevenZip.FS.stat(fullPath);
                        if (this.sevenZip.FS.isDir(stat.mode)) {
                            files.push(...this.collectFiles(fullPath));
                        } else if (this.sevenZip.FS.isFile(stat.mode)) {
                            if (!fullPath.match(/\.(7z|zip|rar|tar|gz|bz2|xz|cab)$/i)) {
                                files.push({
                                    path: fullPath.substring(1),
                                    name: entry,
                                    data: this.sevenZip.FS.readFile(fullPath),
                                    size: stat.size
                                });
                            }
                        }
                    } catch (e) {}
                }
            } catch (e) {}
            return files;
        }

        cleanup() {
            if (!this.ready) return;
            const files = this.collectFiles('/');
            for (const f of files) {
                try { this.sevenZip.FS.unlink('/' + f.path); } catch(e) {}
            }
        }
    }

    window.sevenZipEngine = new SevenZipEngine();
    window.sevenZipEngine.init().then(ok => {
        window.sevenZipReady = ok;
        console.log('7z引擎状态:', ok ? '就绪' : '失败');
    });
    </script>
</body>
</html>
